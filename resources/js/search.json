[[{"l":"Welcome","p":["Below you can find reference links to my blog posts, writeups and educational content.","Home"]},{"l":"Featured"}],[{"l":"Blog"}],[{"l":"Active Directory Home Lab with Proxmox - Part 5","p":["Connecting Linux machines to an Active Directory (AD) domain can streamline user authentication and management in mixed-environment networks. In this post I will guide you through the process of joining a Linux machine to a Windows Active Directory domain, allowing for centralized authentication and simplified access control for your Linux servers."]},{"l":"Setting Up Your Web Server","p":["To begin, we'll provision a new AlmaLinux container.","You need to make a privileged container in order to join it to the domain. To do this you first make a regular LXC, make a backup and restore it as privileged.","This container will serve as our web server and the machine we'll join to the Active Directory domain."]},{"l":"Installing Necessary Packages","p":["Before joining the domain, you need to install several key packages that facilitate communication and integration with Active Directory. It's always a good practice to ensure your system is up-to-date before installing new software.","First, update and upgrade your existing packages:","Next, install the required packages. These include sssd(System Security Services Daemon) for authentication and identity management, realmd for domain joining, oddjob and oddjob-mkhomedir for home directory creation, adcli for Active Directory command-line tools, samba-common and samba-common-tools for Samba utilities, krb5-workstation for Kerberos authentication, and openldap-clients for LDAP client utilities."]},{"l":"Joining Active Directory","p":["With the necessary packages installed, you can now join your AlmaLinux machine to the Active Directory domain. This is done using the realm command, which simplifies the process of configuring Kerberos and SSSD for domain integration.","Execute the following command, replacing CICADA.LOCAL with your actual domain name and Administrator with an Active Directory user account that has permissions to join machines to the domain:","You'll be prompted to enter the password for the Administrator account. If the join is successful, you can verify it by checking the machine's domain status. The id command with the machine's hostname followed by a dollar sign and the domain ( web01$@CICADA.LOCAL) should show that the machine is recognized as a domain computer.","As you can see, our machine is now recognized as a domain computer within Active Directory."]},{"l":"Configuring SSSD and PAM for AD Integration","p":["To enable users to authenticate against Active Directory and have their home directories created automatically upon login, you need to configure SSSD and edit the PAM (Pluggable Authentication Modules) configuration for SSH.","First, ensure openssh-server is installed, as it's crucial for remote access and is often a primary way users will interact with the joined Linux machine.","Next, start and enable the sssd and oddjobd services. SSSD is responsible for handling authentication and identity lookups against Active Directory, while oddjobd(along with oddjob-mkhomedir) helps with tasks like creating home directories for domain users.","Now, edit the PAM configuration for SSH (/etc/pam.d/sshd) to allow SSSD to handle authentication and to enable automatic home directory creation.","Finally, configure the sssd.conf file to specify how SSSD should interact with your Active Directory domain. This file defines the domain settings, default shell, home directory creation, and access providers."]},{"l":"Authenticating with Kerberos and SSH","p":["To enable Kerberos authentication, you need to configure the /etc/krb5.conf file on your local machine. This file tells your system how to locate the Kerberos Key Distribution Center (KDC) for your domain. Add the following configuration:","Now, you can request a Kerberos Ticket Granting Ticket (TGT) for a domain user and then use it to SSH into the Linux machine without needing to enter a password for each connection.","First, use kinit to obtain a TGT for your domain user (e.g., w.wonder):","After entering the password, you can verify that you have a valid TGT using klist. Finally, you can SSH into your AlmaLinux machine using your domain username.","You should be logged in without being prompted for a password, demonstrating successful Kerberos authentication and Active Directory integration!"]},{"l":"Conclusion","p":["By following these steps, you've successfully joined your Linux machine to a Windows Active Directory domain. This setup allows for centralized user authentication and management, significantly simplifying administration in environments with both Windows and Linux systems. Users can now seamlessly log in to your Linux machines using their Active Directory credentials, benefiting from single sign-on capabilities."]}],[{"l":"Anti-Virus Evasion with Sliver C2"},{"l":"Sliver C2","p":["My recent exploration into C2 frameworks led me to BishopFox's Sliver project. While its capabilities are impressive, I quickly encountered a common challenge: Windows Defender's detection of beacon payloads on my Windows VM. In order to enhance my red teaming skills, I decided to dig into leveraging a custom stager, DInvoke and FilelessPELoader, together with common evasion techniques for building my own Sliver shellcode loader."]},{"l":"What is a shellcode loader?","p":["A shellcode loader is a small piece of executable code designed to, as its name would suggest, load and execute shellcode (being a larger payload) into a target process's memory. Think of it as the initial delivery mechanism. Shellcode loaders often go along with techniques like process injection, allowing attackers to run arbitrary code within a legitimate process, that bypass traditional security controls focused on executable files on disk.","The loader will act as a Stage 1 payload (e.g. stager.txt). Its primary purpose is to establish communication with a command and control (C2) or payload server and download the larger, more feature-rich (and often encrypted) Stage 2 payload. The second stage payload is the main malicious code that we as an attacker intend to execute on the target system.","Stager diagram","For this blog post our final payload will be a Sliver beacon. The goal is to create a stager with the following properties:","Natively supported by Windows without too much dependencies.","Bypass common defenses found on modern operating systems (e.g. signature checks).","Use commonly whitelisted protocols in order to bypass firewall rules and fit in with normal traffic (e.g. web traffic)."]},{"l":"Sliver Setup","p":["For more information on installing and using Sliver, see the official wiki.","From Sliver v1.5 you can make extensive customizations to the HTTP C2 traffic generated by the server and implant by modifying the HTTP C2 configuration file, which by default is located at ~/.sliver/configs/http-c2.json. To be able to blend in more with normal traffic, I made some minor modifications to this file.","Next, we can generate our HTTPS beacon shellcode with basic obfuscation features enabled.","This command will save the shellcode for our Sliver beacon in /tmp/rev.bin. If you want to generate an executable (default) that will be executed on the target we can use do this as well. After generating the beacon, we start an mTLS listener.","Generating a Sliver beacon and listener","We can convert the executable to a .bin file with Donut. Donut is a tool focused on creating binary shellcodes that can be executed in memory. Its primary strength lies in its ability to convert executables (.exe), dynamic-link libraries (.dll), .NET assemblies, VBScript, and JScript into shellcode. This shellcode can then be injected into a running process, allowing for fileless execution of malicious payloads. I'll use Donut with the -b 1 flag to not add AMSI bypass and the -e 3 flag for encryption.","The idea is that our final stager will grab this binary shellcode file and execute it in memory. There are plenty of existing PE loaders to perform Process Injection into a target process. However, as a learning experience I wanted to create my own loaders."]},{"l":"Method 1: FilelessPELoader (C++)","p":["FilelessPELoader enables the loading and execution of Portable Executable files directly from memory, avoiding disk writes. It also encorporates AES encryption and decryption of the shellcode in memory to further enhance obfuscation.","In order to evade detection, we will need to make our hands dirty and use manual obfuscation techniques. These include string encryption, control flow obfuscation, instruction substitution, and anti-analysis measures. We can either use ThreatCheck or DefenderCheck to see if our executable gets picked up by Anti-Virus.","Let's first clone the project and compile our binary without any modifications.","FilelessPELoader (No obuscation)","From the above output, we can see that ThreatCheck has identified some bad bytes that are detected by our AV. To fix this I removed all comments, any unnecessary print statements or functions, and reversed several function names. I am not going into detail on how to obfuscate the code, since it should be relatively easy to bypass any signature checks.","FilelessPELoader (Ofbuscated)","The project comes with a custom aes.py script that can be used to encrypt any file we want. Running the script will generate two files.","The idea is that our loader will fetch the encrypted binary ( cipher.bin) together with a key ( key.bin) in order to decrypt it. The generated files can be passed to our loader as arguments."]},{"l":"FilelessPELoader Execution","p":["Now we can try running our modified FilelessPELoader executable.","Don't forget to specify the IP and PORT as well as the encrypted payload and key files as arguments.","FilelessPELoader Sliver Beacon","The only problem with this method is that the process will keep on running until it is exited by the user. It also shows up in task manager, which is not very stealthy."]},{"l":"Method 2: DInvoke Stager (.NET)","p":["To build a more stealthy stager, I decided to make use of DInvoke by TheWover. Using DInvoke, we can use Dynamic Invocation to load unmanaged code via DLLs at runtime. The traditional way (using PInvoke) involves the program declaring beforehand which functions it will use, and the operating system helps to link them up. Dynamic Invocation, on the other hand, looks up the address of a function in memory at the exact moment you need it, rather than declaring it beforehand. This makes it harder for analysis since traditional tools will monitor these pre-declared links to see what the program is doing.","DInvoke helps us to avoid API Hooking by calling arbitrary code from memory, while also avoiding detections that look for imports of suspicious API calls via the Import Address Table. For more information about the DInvoke project, be sure to read TheWover's blog post where he demonstrates how the project works.","In order to make use of DInvoke as a shellcode loader, I made a few modifications to an existing project of Kara-4search. I changed the original code in order to download the shellcode from a web server and then load it into memory. The applied changes can be seen below.","DInvoke Loader (adapted)"]},{"l":"Obfuscation with InvisibilityCloak","p":["After making those minor adjustments to the shellcode loader, the next step is to make it harder to get detected by traditional Anti-Virus by doing code obfuscation. The InvisibilityCloak project provides a user-friendly set of tools to quickly make modifications to your project. This toolkit can perform actions such as renaming the project files, changing its unique identifier (GUID), scrambling the text strings within the code, removing any developer comments, and stripping out debugging information stored in program database (PDB) files.","Clone the project, compile the binary and run the command below in order to rename the project and apply string reversing as the obfuscation method.","From the output we see that we have succesfully obfuscated the project. Before compiling, let's change all string references of DInvoke to another custom string (e.g. \"s3rp3nt\"). We will also change the project output type to be a Windows Application in order to avoid a console pop-up when executing the binary.","DInvoke loader"]},{"l":"AV Check","p":["With our loader ready, we can verify if our file is not getting detected as malicious by running ThreatCheck or DefenderCheck."]},{"l":"DInvoke Execution","p":["Now with everything set lets try to get a beacon from our victim machine. First convert the beacon executable to binary shellcode format if you haven't already (see Donut example above).","Sliver DInvoke Loader","After executing our custom shellcode loader, we can see it has grabbed our beacon file from our Python server ( rev.bin), loaded the shellcode in memory and connected to our server without alerting Windows Defender. You see that I get a couple of beacon connections, because I ran the executable a couple of times."]},{"l":"Method 3: Custom Encrypted Stager","p":["Now Sliver has actually built-in support for custom stagers making use of encryption and compression when serving stages. First we need to setup our profile, listener, and stage listener with the following command:","Sliver Stager Setup","By making some modifications to their Encrypted Stage Example code, we can add additional functionality to inject our shellcode into a running process by using a techniques called Process Hollowing.","Process hollowing is a technique to execute code under the guise of a legitimate process. It works by creating a new process in a suspended state, typically a benign system executable like svchost.exe, and then unmapping or \"hollowing out\" its original memory. We can then inject our own malicious code into this memory space and resume the process, making it appear as though the legitimate process is running.","Just as before, we can use InvisibilityCloak on the project from Cyb3rDudu. This project makes use of the Sliver encrypted stager incorporating AMSI bypass, process injection, hollowing and much more. We can compile the project in Release Mode and convert the DLL to raw bytes.","Convert the raw bytes to Base64 with a CyberChef recipe.","SliverLoader Base64 Recipe","Next convert the AESKey and AESIV to hex using another CyberChef recipe.","SliverLoader AESkey Recipe","Copy the Base64 data and paste it into a PowerShell script.","This script is a PowerShell loader that is hosted on our server, intented to be downloaded and executed once an attacker gains code execution. The script will load the stager into memory via reflection and performs the DownloadAndExecute operation that downloads our Sliver agent from our payload server and executes it."]},{"l":"Encrypted Stager Execution","p":["Our PowerShell loader can be hosted on a webserver as a normal file. On the victim, the following command executes the download and staging of the agent which will result in an incoming session in sliver.","In a minute we should get a session in Sliver without Defender stopping us.","Sliver Session"]},{"l":"Privilege Escalation","p":["Since we now have an active beacon on our target, we can even go a step further and escalate privileges on the host. Use one of the beacons and run sa-whoami(installed via armory). This will run a whoami /all in a more safe way.","We see our user is part of the Administrators group but we are not in a high integrity process. This means that we have to bypass UAC (User Access Control) to get a shell with full Administrator privileges. There is an excellent project called UAC-BOF-Bonanza that includes Beacon Object Files that can be loaded to Sliver in order to bypass UAC. After cloning the repository, we can load them into Sliver as follows (e.g. CmstpElevatedCOM):","The above UAC Bypass creates an elevated ICMLuaUtil COM object and calls its ShellExec function to execute the provided file on disk. If it is the first time using these custom extension, restart the Sliver server. We can now run the CmstpElevatedCom task from within our beacon that executes our loader.","Sliver Privesc","This will launch another beacon process running as Administrator. With these privileges we can try to dump all credentials from LSASS. To stay stealthy, let's use SharpSAMDump.","We managed to obtain the hashes of all accounts on the machine, including the administrator hash."]}],[{"l":"Active Directory Home Lab with Proxmox - Part 4","p":["In this part of our Active Directory Home Lab series, we'll focus on enhancing the security and visibility of our environment by adding network monitoring. Since we're utilizing PfSense as our software-based firewall, it provides a convenient platform for deploying additional security tools. Specifically, we'll be setting up Suricata, a powerful intrusion detection and prevention system (IDS/IPS), to monitor traffic and detect potential threats. This post will guide you through configuring Suricata and creating custom rules to detect attacks, such as those we simulated in Part 3."]},{"l":"Suricata Setup","p":["To begin, navigate to the PfSense web interface and proceed to System Package Manager Available Packages. Search for Suricata and install the latest version. Once installed, go to Services Suricata to start configuring the tool. We’ll add interfaces and tweak some options, but the default settings should suffice for most purposes. For our ruleset, we'll use the ETOpen Emerging Threats as a foundation."]},{"l":"Adding Monitoring Interfaces","p":["Under the Interfaces tab, select the interfaces that Suricata will monitor. For our lab, I chose the LAN and ADLAB interfaces to observe traffic between the attacking VM on the LAN and the AD network.","PfSense-suricata-interfaces"]},{"l":"Creating Custom Detection Rules","p":["Next, let's create custom rules tailored to our lab environment. We’ll do this by editing one of the interfaces and navigating to the rules tab."]},{"l":"Detecting Evil-WinRM Traffic","p":["Our first custom rule will detect Evil-WinRM traffic, which is often used for remote management in penetration testing scenarios. For more information on setting up Remote Management on your target hosts, refer to Part 3 of this series.","PfSense-suricata-rules","To build this rule, we need to understand how an authentication request from Evil-WinRM appears in network traffic. Using WireShark, we can capture an authentication attempt from a host on the LAN interface. We run the following command in a Linux terminal:","To capture this traffic in PfSense, go to Diagnostics Packet Capture and select the appropriate interface.","Ensure you target the domain-joined host from a machine outside of the LAN to properly capture traffic. If you capture traffic from devices within the same LAN, PfSense may not log the packets unless you create a port mirror. At the final section, I will discuss how to setup a SPAN port and route traffic to another machine to monitor traffic.","In WireShark, we can focus on the packet containing the authentication request.","PfSense-capture-winrm","The captured packet shows the authentication request from winnie.wonder. Based on this, we can now craft our Suricata rule:","Snort is a similar IDS/IPS solution that can be installed on PfSense, but has slightly different syntax.","Explanation:","The rule targets HTTP traffic performing a POST request on port 5985.","It looks for the Ruby WinRM Client string in the User-Agent header, a unique identifier for Evil-WinRM.","The rule then examines the Authorization header, decoding a portion of the Base64 encoded data to detect the NTLMSSP authentication type.","With this rule in place, Suricata will trigger an alert whenever someone tries to authenticate using Evil-WinRM using the default settings. We could tune this rule even further, or write additional rules that alert on traffic even if the attacker changes the User-Agent.","PfSense-suricata-alert"]},{"l":"Detecting SMB Authentication","p":["Similarly, we can create a custom rule to detect SMB authentication attempts within the CICADA domain. The below rule looks for the SMB header with the NTLMSSP authentication type set to 03 and the domain name in hex format, separated by null bytes.","This rule was applied to the ADLAB interface. To test it, I used NetExec to initiate an SMB authentication from outside the ADLAB interface:","As expected, Suricata raised an alert upon detecting the authentication: PfSense-suricata-alert2"]},{"l":"Detecting AS-REPRoasting","p":["In the third part of our series, we executed the following command to perform an ASREPRoasting attack on domain users:","Now, let’s examine what this traffic looks like in WireShark PfSense-capture-asrep","In this scenario, we identified one user with preauthentication disabled. By analyzing the AS-REQ packet, we can craft a Suricata rule to detect this type of attack:","Rule Breakdown:","The rule monitors TCP traffic on port 88, which is used by Kerberos.","It looks for a specific sequence of bytes that indicate the presence of an AS-REQ request.","The string krbtgt (represented as 6b 72 62 74 67 74 in hexadecimal) is a key identifier within the packet.","We also check for the absence of the byte sequence a2 03 02 01 0c, which indicates the presence of preauthentication. The lack of this sequence suggests the possibility of an AS-REP Roasting attack.","By implementing this rule, Suricata will trigger an alert when it detects a pattern consistent with an ASREPRoast attack, helping to protect your domain from this common exploitation method."]},{"l":"Creating SPAN Ports on Proxmox","p":["Start by creating a new LXC and assign at least 2 cores, 2GB of RAM and 25GB of storage. After creating the container, add another network interface for the ports you want to mirror. In my case I added interfaces vmbr1 and vmbr2. The interface is going to send copies of packets of machines connected to the switch to the container. Make sure the firewall is unchecked for these interfaces. Suricata LXC Net","Log in to the container and run the following commands.","If the interfaces are down, just run ip link set INT_NAME up. Next, open the shell on your Proxmox server, and run the command:","where the LXC_ID is the id of the Proxmox node where Suricata is running. Suricata Proxmox link","The first result is the interface that is connected to my home network, the last two are going to be the SPAN ports. Now we run the following command in the Proxmox shell to create the SPAN ports on the switch:","Replace the link names, ids and bridge name according to your setup. Next we need to edit the configuration file of Suricata located at /etc/suricata/suricata.yaml:","Add our IP ranges to the HOME_NET variable under vars to hold [172.16.0.0/24,172.16.100.0/24].","Change the interface under af-packet from eth0 to the monitoring interface. I added both mirrorInt and mirrorAD as an interface and assigned it a cluster-id of 99 and 100 respectively.","Change the default rule path under default-rule-path to /etc/suricata/rules and add another rule-files value for any local rules (e.g. local.rules).","Create the custom rule file under /etc/suricata/rules/local.rules. Here we can place our custom rules we created earlier.","Finally we can restart Suricata on the container and monitor the two added interfaces. Any alerts will be logged to fast.log.","After this, we should be able to capture all traffic coming from our network in pfSense (even same-LAN traffic). One issue we are having now is that the port mirror command needs to be ran each time the container is restarted. It is possible to create a hookscript for this. Check out this post to create a custom script to run at VM start and stop. Since we created a LXC, it is (at the time of writing) not possible to create hookscripts for containers, but you can always create a hookscript on the pfSense VM that creates the SPAN ports at boot for the Suricata container."]},{"l":"Conclusion","p":["In this part we have seen how we can leverage Suricata to detect malicious traffic on our network. We have also learned how we can write our own rules based on IOCs. By implementing these custom rules, you can enhance the security of your Active Directory lab environment, gaining visibility into specific attacks and unauthorized access attempts."]}],[{"l":"Active Directory Home Lab with Proxmox - Part 3","p":["We are now going to add some simple misconfigurations to our AD Lab. In the final section we will verify them by targeting our network from an outside Linux VM. To make the Active Directory Lab vulnerable we first need to change some settings."]},{"l":"Group Policy Configuration","p":["Open the Start menu and click on Windows Administrative Tools, then choose Group Policy Management. Expand Forest and Domains, to view your own domain."]},{"l":"Disable Windows Defender and Firewall","p":["We can create a first GPO that will disable the Windows Defender Firewall so we can more easily experiment with attacks later on. Of course we could also disable (unlink) the policy later.","Do not do this in a real enterprise environment! You can skip this step if you don't want to make your lab vulnerable.","Right-click on the domain name. Select Create a GPO in the domain and link here. Give the GPO the name Disable Protections. Right-click on the newly added policy and choose Edit.","This will open the Group Policy Management Editor. From the sidebar go to the following folder: Computer Configuration Policies Administrative Templates Windows Components Microsoft Defender Antivirus. Select Microsoft Defender Antivirus. From the right side select Turn off Microsoft Defender Antivirus and click on Edit policy setting. Set it to Enabled. Click on Apply then OK to save the changes.","vulnerability-setup-1","Next go to Real-time Protection and enable Turn off real-time protection.","vulnerability-setup-2","Expand the sidebar folders to the following: Computer Configuration Policies Administrative Templates Network Network Connections Windows Defender Firewall Domain Profile. Disable the Windows Defender Firewall: Protect all network connections setting.","vulnerability-setup-3","Close Group Policy Management Editor. From the sidebar of Group Policy Management right-click on Disable Protections and choose Enforced."]},{"l":"Enable WinRM Server","p":["Right-click on your domain name. Select Create a GPO in the domain and link here. Give the GPO the name Enable WinRM Server. Right-click on it and choose Edit. Using the sidebar go to the following folder: Computer Configuration Policies Administrative Templates Windows Components Windows Remote Management (WinRM) WinRM Service. Select Allow remote server management through WinRM and then click on Edit policy settings. Set the policy to Enabled and in the IPv4 filter field enter *. Click on Apply then OK.","vulnerability-setup-4","Optionally you can enable Allow Basic authentication and Allow unencrypted traffic if you want people to perform Man-in-the-Middle attacks.","Next navigate to Computer Configuration Preferences Control Panel Settings. Right-click on Services and select New Service.","vulnerability-setup-5","Set Startup to Automatic. Use the ... button to select the service name. Select Windows Remote Management (WS-Management) and click on Select. Set the service action to Start Service.","vulnerability-setup-6","Once again in the sidebar navigate to Computer Configuration Policies Administrative Templates Windows Components Windows Remote Shell. Select Allow Remote Shell Access and enable it.","vulnerability-setup-7","Finally go to Computer Configuration Policies Security Settings Windows Firewall with Advanced Security. Right-click Inbound Rules and create a New Rule.","vulnerability-setup-7.0","Select Predefined and choose Windows Remote Management from the list (not the one with compatible). Click Next. Select the one for Domain and Private, and Allow the connection at the next screen.","You can scan port 5985 on one of your remote computers to see if it responds (it might need a restart):"]},{"l":"Additional Registry Edit","p":["I found that when applying the GPO to the domain, I was still not able to WinRM from a remote host. I found that enabling the WinRM service throught the Registry solved the issue. To do this go to Computer Configuration Preferences Registry. Right-click and select New Registry Item. As the registry path select HKEY_LOCAL_MACHINE\\SOFTWARE\\Policies\\Microsoft\\Windows\\WinRM\\Service and set the value of the IPv4Filter to * or whatever IP range you want to include.","vulnerability-setup-7.1"]},{"l":"Adding a Public File Share"},{"l":"Local Share","p":["Login as a local administator to one of your Windows VMs and navigate to Control Panel Network and Internet Network and Sharing Center Change Advanced sharing settings Guest or Public Turn on File and Printer sharing.","Next create a new folder, Right-click and go to Properties Sharing tab Share and give the Everyone user read permission.","vulnerability-setup-9","If you want to allow users to access the file share as a Guest user, then open Local Security Policy as an Administrator. Next go to Local Policies Security Options Accounts: Guest account status and switch it to Enabled.","vulnerability-setup-8","In the same window go to User Rights Assignment Deny access to this computer from the network and make sure that the Guest account is not in this list."]},{"l":"Enforce the Domain Policies","p":["Right-click on the Start menu and select Windows PowerShell (Admin). In the terminal enter the following:","Now whenever a new device joins our AD environment the Group Policies that apply to all the devices will automatically be applied to them. With this, we have completed the Domain Controller setup."]},{"l":"Account Misconfigurations"},{"l":"ASREP Roasting","p":["In older versions of Kerberos, it was possible to allow authentication without a password. Since Kerberos 5, a password is required, which is called Pre-Authentication. If an account has the option Do not require Kerberos preauthentication checked, an attacker can send any request for authentication to the KDC to retrieve an encrypted TGT that can be brute-forced offline.","asreproast-enable"]},{"l":"Attacking our Environment"},{"l":"Browsing Public Shares","p":["Lets start by checking if we can see any available shares on the network. I made one public share on the Windows VM with IP 172.16.200.11. In Part 1 of this series we added an attacker VM to the AD network as our initial entry point that is whitelisted from the firewall. From this host, we should be able to list the share we made public.","We can see one public folder called Department and look at what information is stored inside."]},{"l":"Evil-WinRM","p":["To verify that we can also WinRM to our Windows VMs I created a honeypot account called winnie.wonder with the password P@ssw0rd123 and logged into MS01 with this account. By default, PowerShell Remoting (and WinRM) only allows connections from members of the Administrators or Remote Management Group. To add our user to the Built-In Remote Management Users run:","We can now execute the following command from a Linux host inside the network:","Nice! We can now run remote commands using the tool Evil-WinRM."]},{"l":"ASREPRoasting","p":["Assuming we have gathered a list of valid users, we can try to perform an ASREPRoast attack on the domain users to see if any account has the Do not require Kerberos preauthentication option set. With a valid list of users, we can use Get-NPUsers.py from the Impacket toolkit to hunt for all users with Kerberos pre-authentication not required.","Look like we got a valid hash for the user winnie.wonder. We can crack the hashes offline using Hashcat with mode 18200 to find the password."]},{"l":"Conclusion","p":["The possible attack surface in an AD environment is very large so we just introduced a few misconfigurations in our home lab. We also went over on how an outsider can find these flaws to possible gain a foothold on one of our systems. In the next part of this series we will look at how we can monitor and defend against these attacks."]}],[{"l":"Active Directory Home Lab with Proxmox - Part 2","p":["In this post, we're diving into the setup of Windows virtual machines (VMs) in a Proxmox home lab, with the ultimate goal of building an Active Directory (AD) environment. This includes creating a Domain Controller that will also serve as the DHCP server for our AD Lab, and joining a Windows 10 host to the domain. By the end of this guide, you'll have a functional AD lab that you can use for learning, experimenting, and testing."]},{"l":"What You'll Need","p":["To get started with setting up your Windows VMs and creating the AD Lab, make sure you have the following:","Windows VirtIO Drivers: Necessary for better performance and compatibility of Windows VMs in Proxmox.","Windows Server 2022 ISO: For setting up the Domain Controller.","Windows 10 Enterprise Evaluation ISO: For joining a client machine to the domain.","The ISOs typically have a lifespan of 90 to 180 days, but they can often be extended. To be safe, consider taking a snapshot of your VMs right after installation to revert back if needed."]},{"l":"Setting Up the AD Lab","p":["We'll start by uploading the necessary ISOs to our Proxmox server. For this guide, we'll create two VMs: a Windows 10 machine and a Domain Controller. Since the setup for both is quite similar, we'll focus on the Domain Controller."]},{"l":"Step 1: Create the Domain Controller VM","p":["Create a new Virtual Machine and select the Windows Server 2022 ISO image you downloaded. Check the box to add an additional drive for the VirtIO drivers and select the corresponding ISO image.","DC-Setup","Enable the \"Qemu Agent\" in the system tab and use the following configuration for the disks.","DC-Setup-1","It's recommended to assign at least 8GB of RAM and 2 CPU cores. Skip through the remaining settings, and ensure you select vmbr3 as the network interface bridge (AD LAB).","DC-Setup-2","Start the VM and press enter to go into the installation process. Begin the installation process by choosing the Windows Server 2022 Standard Evaluation (Desktop Experience) as the operating system. Proceed with the custom installation.","DC-Setup-3","Follow the installer steps until you reach the installation step where you need to select the location to install Windows Server. Click \"Load driver\" to install the VirtIO drivers for hard disk and the network. Browse to the CD drive where you mounted the VirtIO driver and select folder vioscsi\\2k22\\amd64 and confirm. Select the \"Red Hat VirtIO SCSI pass-through controller\" and click next to install it. Repeat this for the NetKVM\\2k22\\amd64 and Balloon\\2k22\\amd64 folders.","DC-Setup-3.1","The first thing to do after the first boot is to rename the computer. Go to Settings System About Rename This PC. I renamed mine to DC01 and chose to restart later.","Since this machine will serve as the DHCP server, it needs a static IP. Go to Control Panel Network and Internet Network and Sharing Center Change Adapter Settings, and configure the network interface with a private IP address (e.g., 172.16.200.100). Set the DNS server to 127.0.0.1, since the DC will also be a DNS server.","DC-Setup-4"]},{"l":"Step 2: Install Active Directory Domain Services","p":["Open Server Manager and select Add roles and features. Accept the default settings until you're prompted with the Server Roles section. Select Active Directory Domain Services and add the necessary features. Once it has installed successfully, select Close. I also installed the DNS and DHCP Server Features together with Active Directory Certificate Services, but this is optional.","DC-Setup-ad-services","The next step is to promote the server to a domain controller. You will need to have the domain name you want to use in the next step. I will choose the domain name of cicada.local. To promote the server to a domain controller, click on the notification icon on the top section of the Server Manager program. Then select Promote this server to a domain controller. Select Add a new forest as this is a newly created AD environment. Enter the domain name in the root domain name field. Once the Windows Server has rebooted, you will see the login screen show the domain entered in the previous step."]},{"l":"Step 3: Create a Domain Admin Account","p":["After logging in, open Active Directory Users and Computers. As I like to keep things organized, I will create a new group for all the user accounts. Right click on your domain and select New Organizational Unit and name it Groups. Move all group related objects from the Users to the Groups folder. Right click on the Users folder and select New User.","DC-Setup-5","Fill in the user details and set a password for the account. Disable the option User must change password at next logon and check the Password never expires. In an organization, the former should be checked so that the end user can set their own password.","Now we need to add the newly created account to the Domain Admin group. This can be done right clicking the newly created user and selecting Properties. Select the Member of Add. Under the Enter the object names to select section, click on the Advanced button. Then click Find now Domain Admins and click OK.","We can then logout of the Administrator account and login with our newly created domain account. Whenever we create a new user account, they are able to login with their credentials on any domain joined host."]},{"l":"Step 4: Configure the DHCP Server","p":["Go to Server Manager Add roles and Features, select DHCP Server, and complete the installation. Once done, complete the DHCP configuration through the notifications in Server Manager.","We then have to configure a DHCP scope. To do so, go to Server Manager once again. Then select Tools DHCP. Expand the available options and then right click on IPv4 to create an IPv4 Scope. Set a name for the scope and give it a description if you wish to do so. Select Next and set the range to be somewhere inside the 172.16.200.1/24 network. I choose the starting IP to be 172.16.200.11 to give me some room in case I want to add some static IPs later. You can also exclude some IP addresses if you want to.","DC-Setup-6","When prompted if you want to configure DHCP options for this scope now, choose Yes, then select Next. You will then be prompted to select the IP address for the default gateway. The IP address we gave our default gateway was 172.16.200.1. Enter that and click on Add. Then select Next."]},{"l":"Add Windows 10 VM to Domain","p":["Go through the initial setup wizard and login with the local account you created. The next step is to join the Windows 10 VM to the domain. To do so, open the Settings program and go to Accounts Access work or school Connect. In the pop out window, select the option Join this device to a local Active Directory domain. Enter the domain name we used to configure our Active Directory forest (I used cicada.local). You will then be prompted for a login.","Windows 10 will restart after entering the credentials. After rebooting, you can now login to the domain by selecting Other User in the lower left corner."]},{"l":"Conclusion","p":["Congratulations! You now have a fully functioning Active Directory home lab. With your Domain Controller and Windows 10 VM set up, you’re ready to explore, experiment, and even simulate attacks to understand how AD environments operate and how they can be secured or compromised. In the next part, we’ll delve into common misconfigurations in Windows and Active Directory and explore how attackers might exploit them. Stay tuned!"]}],[{"l":"Active Directory Home Lab with Proxmox - Part 1","p":["In this post, I'll walk you through setting up my personal homelab - a project that serves both as a hands-on learning experience and as a future reference. While this documentation is partly a note to my future self, it's also a guide for anyone interested in gaining a deeper understanding of system administration, including networking, firewall configuration, and policy management. Ultimately, the goal is to create an environment where I can safely experiment with Active Directory (AD) misconfigurations and vulnerabilities, culminating in a simulated attack on my own lab."]},{"l":"Network Setup","p":["The backbone of this homelab is a segmented network architecture that isolates various virtual machines (VMs) from my home network using a firewall. We'll use pfSense as our firewall solution and Proxmox for managing the VMs. I’ll keep the initial setup straightforward, focusing on getting the basic system up and running. Here’s a schematic overview of the homelab architecture:","Proxmox Setup","We’ll establish three distinct networks behind the pfSense firewall:","Internal Network: For regular machines ( 172.16.0.1/24)","Cyber LAB: A playground for experimenting with vulnerable machines and data ( 172.16.100.1/24)","Active Directory LAB: A dedicated Windows-only AD environment ( 172.16.200.1/24)","pfSense will act as the gateway (router) and firewall for our homelab, so it should always be the first thing you boot up when using the lab.","Later on in this series, we will also add our own Intrusion Detection System (IDS) with Suricata. This will be a host that captures all traffic from your networks of choice and alerts for suspicious events."]},{"l":"System Requirements","p":["To ensure smooth operation, here’s what you’ll need:","A 64-bit multi-core CPU (minimum 4 cores) with virtualization support","16GB of RAM","250GB of disk space","A bootable Proxmox VE drive (ISO)"]},{"l":"Proxmox Setup","p":["Installing Proxmox is relatively simple, so I’ll skip the step-by-step details but you can go ahead and follow their official Getting Started. After a successful installation, you should be able to access the login portal via the IP address you specified.","login","Once logged in, we’ll create two new OVS bridged interfaces alongside the default vmbr0 Linux bridge interface. Your CIDR and gateway might vary depending on your network configuration.","proxmox-network","For better organization, consider creating new pools for your networks. This can be done by navigating to Datacenter Permissions Pools Create. When you start creating VMs, you can assign them to one of these pools.","To upload ISOs to Proxmox go to lab local (lab) ISO Images Upload."]},{"l":"Setting Up PfSense","p":["After creating the VM, assign it to our previously created bridge interfaces by going to Hardware Add Network Device and selecting vmbr1. Repeat this process for vmbr2 and vmbr3.","After setting up pfSense, you can create new hosts and assign them the vmbr1 NIC on the LAN. From any host on the 172.16.0.1/24 network, you can access the pfSense web interface for further configuration.","Change the above settings according to your network setup (yours might be different).","Complete the pfSense installation and reboot the system. During the initial setup, you’ll be prompted to configure the network interfaces. Here’s how I set it up:","Configure IPv4 address LAN interface via DHCP?: n","Configure IPv4 address OPT1 interface via DHCP?: n","Configure IPv4 address OPT2 interface via DHCP?: n","Configure IPv4 address WAN interface via DHCP?: n","Configure IPv6 address OPT1 interface via DHCP6: n","Configure IPv6 address OPT2 interface via DHCP6: n","Configure IPv6 address WAN interface via DHCP6?: n","Configure IPv6 address WAN interface via DHCP6?: y","Do you want to enable the DHCP server on LAN?: y","Do you want to enable the DHCP server on OPT1?: y","Do you want to enable the DHCP server on OPT2?: n","Do you want to enable the DHCP server on WAN?: n","Do you want to revert to HTTP as the webConfigurator protocol?: n","Download the latest stable ISO of pfSense and create a new VM in Proxmox by clicking the blue box in the top right corner. Select the uploaded pfSense ISO and proceed with the default settings.","Enter the end address of the IPv4 client address range: 172.16.0.254","Enter the end address of the IPv4 client address range: 172.16.100.254","Enter the LAN interface name: vtnet1","Enter the new LAN IPv4 address: 172.16.0.1","Enter the new LAN IPv4 subnet bit count: 24","Enter the new OPT1 IPv4 address: 172.16.100.1","Enter the new OPT1 IPv4 subnet bit count: 24","Enter the new OPT2 IPv4 address: 172.16.200.1","Enter the new OPT2 IPv4 subnet bit count: 24","Enter the new WAN IPv4 address: 192.168.129.52","Enter the new WAN IPv4 subnet bit count: 23","Enter the new WAN IPv4 upstream gateway address: 192.168.128.1","Enter the new WAN IPv6 address: Enter","Enter the Optional 1 interface name: vtnet2","Enter the Optional 2 interface name: vtnet3","Enter the start address of the IPv4 client address range: 172.16.0.10","Enter the start address of the IPv4 client address range: 172.16.100.10","Enter the WAN interface name: vtnet0","For a LAN, press for none: Enter","For the new OPT1 IPv6 address question press Enter","For the new OPT2 IPv6 address question press Enter","Pfsense terminal","Select option 2 and LAN:","Select option 2 and OPT1:","Select option 2 and OPT2:","Select option 2 and WAN:","Should VLANs be set up now? n","We do not setup DHCP as we will let the Domain Controller handle this for us later on."]},{"l":"Configuring Firewall Rules","p":["Let’s set up some basic firewall rules to control traffic between our networks and the outside world. Log into the pfSense dashboard using the credentials admin:pfsense and change the following settings during the setup process:","Step 2: Uncheck override DNS","Step 4: Uncheck the Block private networks from entering via WAN option. Because this is not a real WAN.","Complete the remaining steps by filling out your preferred configuration settings. We can also rename our interfaces that were created by pfSense on the interface tab.","It is useful to assign a static IPv4 address for our attacker VM. This will make it easier for us to apply firewall rules to interfaces that should only be able to reach this VM. To do this go to Status DHCP Leases and click on the + icon to assign a static IP to the Attacker VM. Note that this IP address should be inside the internal LAN address space.","Next go to Firewall Aliases and make a new alias with the following options:","Name: RFC1918","Description: Private IPv4 Address Space","Type: Network(s)","Network 1: 10.0.0.0/8","Network 2: 172.16.0.0/12","Network 3: 192.168.0.0/16","Network 4: 169.254.0.0/16","Network 5: 127.0.0.0/8"]},{"l":"WAN Rules","p":["Go to Firewall Rules WAN Add and make a new rule with the following options:","Action: Pass","Address Family: Ipv4","Protocol: TCP","Source: WAN subnets","Destination: Address or Alias - pfSense IP","Description: Allow pfSense portal access from home network","Replace the pfSense IP field with the real internal IP address of the pfSense VM (in my case 192.168.129.52). This can be viewed at the start menu on the pfSense VM."]},{"l":"LAN Rules","p":["Go to Firewall Rules LAN Add and make a new rule with the following options:","Action: Block","Address Family: Ipv4+IPv6","Protocol: Any","Source: LAN subnets","Destination: WAN subnets","Description: Block access to services on WAN interface","The final LAN configuration will look something like this:","pfsense LAN rule","This makes sure that the internal networks behind the WAN cannot reach our home network. If you want to connect from a device on your home network, you can add another allow rule at the top for that specific IP."]},{"l":"Cyber Lab Rules","p":["Action: Block","Add another rule to end:","Address Family: IPv4+IPv6","Description: Allow to any non-private IPv4 Address (Internet)","Description: Allow traffic to all devices on the Cyber Lab network","Description: Allow traffic to Attacker VM","Description: Block access to remaining devices","Destination: Address or Alias - 172.16.0.5","Destination: Address or Alias - RFC1918 (Select Invert match)","Destination: Cyber Lab address","Go to Firewall Rules Cyber Lab Add rule to end:","pfsense CYBER rule","Protocol: Any","Source: Cyber Lab subnets","The final Cyber LAB configuration will look something like this:","These rules ensure that devices in the Cyber Lab can communicate with each other, access the internet, and interact with the Attacker VM."]},{"l":"AD LAB Rules","p":["Go to Firewall Rules AD Lab Add rule to end:","Action: Block","Address Family: IPv4+IPv6","Protocol: Any","Source: AD Lab subnets","Destination: WAN subnets","Description: Block access to services on WAN interface (home network)","Add another rule to end:","Destination: Cyber Lab subnets","Description: Block traffic to Cyber Lab interface","Description: Allow traffic to all other subnets and Internet","The final AD LAB configuration will look something like this:","pfsense CYBER rule","This setup ensures that devices within the Active Directory domain can communicate freely with each other, while remaining isolated from other networks.","Now we need to restart pfSense to persist the firewall rules. From the navigation bar select Diagnostics Reboot. Once pfSense boots up you will be redirected to the login page."]},{"l":"Conclusion","p":["Congratulations! You’ve successfully set up your firewall rules and segmented your network. The next step is to create virtual machines and add them to the appropriate network segments by selecting the correct bridge interface in Proxmox. In the following part of this series, we’ll configure the Active Directory environment and introduce common vulnerabilities for further experimentation."]}],[{"l":"Attacking JSON Web Tokens","p":["Incorrect handling of JSON Web Tokens (JWTs) can leave a website vulnerable to a variety of attacks. To understand these attacks we first have to know what a JWT token is."]},{"l":"What is a JSON Web Token?","p":["JSON Web Tokens are widely used for authentication, session management, and access control purposes in web applications. It is a compact and self-contained way to securely transmit data (\"claims\") between server and client as a JSON object. These tokens can be signed using a secret or a public/private key pair. A typical JWT token consists of 3 main parts:","Header: contains algorithm and type","Payload: contains user information","Signature: validates the above portions with a secret key or public/private key pair. Without knowing the server's secret signing key, it should be impossible to generate the correct signature for a given header or payload.","All of these parts are separated by a dot character and base64 encoded, as show in the following example:"]},{"l":"Attacking JWT Tokens","p":["JWT vulnerabilities typically arise due to flawed JWT handling within an application, meaning that the signature of the token is not properly verified. Even if the signature is correctly verified, the trust relies heavily on the security of the secret key."]},{"l":"Improper signature verification","p":["If the server does not properly verify the signature, anyone is able to make arbitrary changes to the content of the token. For example, suppose the JWT contains the following claims:","If the server identifies the session based on the username, modifying its value might enable an attacker to impersonate other logged-in users. Similarly, if the isAdmin value is used for access control, this could provide a simple vector for privilege escalation."]},{"l":"Accepting tokens with no signature","p":["The JWT header contains an alg parameter telling the server which algorithm was used to sign the token. This means that it also tells which algorithm to use when verifying the signature.","JWTs can be signed using a range of different algorithms, but can also be left unsigned. In this case, the alg parameter can be set to none, which indicates a so-called \"unsecured JWT\"."]},{"l":"Algorithm confusion attacks","p":["Algorithm confusion attacks (also known as key confusion attacks) occur when an attacker is able to force the server to verify the signature of a JSON web token using a different algorithm than is intended by the website's developers. This vulnerability typically arises because of a flawed implementation of the token verification. Many libraries make use of a generic method to verify the token that rely on the alg parameter in the JWT header.","Some of the signing algorithms, such as HS256, use a \"symmetric\" key which is a single key to both sign and verify the token. Using a flawed verification process like above enables an attacker to sign the token using HS256 and the public key, where the server will use that same public key to verify the signature. The public key can look something like this:","This means we can make our own JWTs with a forged signature created using the public key and the HS256 algorithm to bypass the authentication completely. Since the JWT was already signed using the public key, the signature verification by the application is successful leading to a successful key confusion attack.","In cases where the public key isn't readily available, you may still be able to test for algorithm confusion by deriving the key from a pair of existing JWTs. This process is relatively simple using tools such as jwt_forgery.py."]},{"l":"JWT header parameter injection","p":["Although only the alg parameter is mandatory, in practice the header often contain other parameters:","jwk: JSON Web Key (can sometimes be exposed on standard endpoints such as /.well-know/jswks.json)","jku: JSON Web Key Set URL for servers to fetch a set of trusted keys","kid: Key ID that servers can use to identify the correct key in cases where there are multiple keys to choose from"]},{"l":"JWK parameter injection","p":["Ideally, servers should only use a limited whitelist of public keys to verify JWT signatures. However, misconfigurations often lead use to use any key that's embedded in the jwk parameter. This makes it possible to sign a modified JWT using your own RSA private key, and then embedding the matching public key in the jwk header. You can see an example of this in the following JWT header:"]},{"l":"JKU parameter injection","p":["The jku parameter points to an endpoint where JWKs are stored used to verify the signature. This can also be changed by an attacker to point to there own generated set of keys.","Example content of the key.json file:"]},{"l":"KID parameter injection","p":["The kid parameter has no concrete structure and can be vulnerable to directory traversal if misconfigured:","Of course you can make the parameter point to any file, but the /dev/null file that is present in Linux systems returns an empty string. This will sign the token with an empty string and results in a valid signature."]},{"l":"JSON Web Token Toolkit","p":["The jwt_tool.py is a very useful toolkit for validating, forging, scanning and tampering with JSON Web Tokens. It can test for a variety of known exploits such as the RS/HS256 public key mismatch vulnerability discussed in this article. Let's look at an example that leverages the key confusion attack on a JWT token when we have access to the public key. The -X k flag can be used for the key confusion attack.","Using this tool we can even inject SQL queries in certain payload fields that we are interested in. We can do this using the -I flag, specifying the claim -pc and value -pv of the payload to tamper. In this example we are changing the current username to be 'admin'."]},{"l":"SQL Injection Payloads","p":["If certain functions on the web application are vulnerable to SQL injection, we can even modify the JWT token to include an injection payload of our choice.","We can then use the newly generated fake token and set it as our session cookie:"]}],[{"l":"Web Fuzzing with FFUF"},{"l":"What is fuzzing?","p":["Fuzzing is \"the art of automatic bug finding\", as described by the OWASP community. It is the act of sending various types of input in HTTP requests, trying to find an input or payload that causes the application to respond in unexpected ways and reveal a vulnerability. In the context of web applications, pentesters use fuzzing to discover directories and files that are hosted on the web server."]},{"l":"Fuzz Faster You Fool","p":["FFUF, short for “Fuzz Faster you Fool”, is an open source web fuzzing tool to discover elements and content within web applications, or web servers. FFUF is known for its speed, flexibility and efficiency and is mostly used by Pentesters and Bug-Bounty hunters. ffuf-scan"]},{"l":"Directory Brute Forcing","p":["FFUF takes two main arguments for brute forcing directories: -u for the target URL and -w for the wordlist. Multiple wordlists can be specified by a comma seperated list if required. Some of the most commonly used wordlists can be found under the GitHub SecLists repository, which categorizes wordlists under various types of fuzzing, even including commonly used passwords. To tell FFUZ where we would like to fuzz we place the word FUZZ where we want our wordlist items to be placed.","If we put everything together, we can craft the command for brute forcing:"]},{"l":"File Discovery","p":["Sometimes we must find out what types of pages the website uses, like .html, .aspx, .php, etc. We can utilize the following wordlist in SecLists for extensions:","Whenever we found the possible extensions that are used by the web server, we can look for all files with those extensions with the -e flag:"]},{"l":"Recursive Fuzzing","p":["When we scan recursively, it automatically starts another scan under any newly identified directories until it has fuzzed the main website and all of its subdirectories. We can enable recursive scanning with the -recursion flag, the depth with the -recursion-depth flag and the extension with -e .php."]},{"l":"VHOST Discovery","p":["Many websites have sub-domains that are not public and hence if we visit them in a browser, we would fail to connect. This is where we utilize VHosts Fuzzing on an IP we already have."]},{"l":"Filtering Options","p":["To display only responses with specific status codes, number of lines, response size, etc, we can make use of several flags:","-mc: specify Status Code","-ml: specify amount of lines in response","-mr: specify regex pattern","-ms: specify response size","-mw: specify amount of words in response","For example, to only show responses with a status code of 200 and 301, use:","Filtering on the other hand can really help in removing false positives from the results. A filter will remove any responses we dont't want to include:","-fw: filter by amount of words","-fl: filter by number of lines","-fs: filter by response size","-fc: filter by status code","-fr: filter by regex pattern","For example, to suppress all responses with a word length of 1000 in a VHOST discovery, we can do the following:"]},{"l":"Request Fuzzing","p":["Ffuf also allows use to fuzz at any position in HTTP headers. To fuzz a URL with a particular HTTP method just add the -X flag and specify the method."]},{"l":"GET Requests","p":["Similarly to how one fuzzes various parts of a website, we can enumerate http parameters. In this example we try to fuzz for available parameters we can use on the admin.php page."]},{"l":"POST Requests","p":["To fuzz the data field in a request, we can use the -d flag. We additionally have to add the -X POST to send POST requests."]}],[{"l":"CSCBE24 - Bad Ransomware","p":["Ransomware attacks are becoming more common every day. This forensics challenge goes in depth into the solution of the 'Bad Ransomware' challenge of the CSCBE24 Qualifiers dealing with a Known Plain-Text Attack on an encrypted zip archive. We are given a ransomware encrypted file by \"connemara\" with a slight variation on the magic sequence."]},{"l":"Scenario","p":["A cookie factory was attacked by the “Bad Ransomware!” ransomware gang. All their cookie recipes have been encrypted. It is your job to recover the cookie recipes!","You have one advantage: you know that the cryptographic design of their ransomware application is flawed.","Good luck!"]},{"l":"Solution","p":["We are given a Zip file encrypted by the \"Bad Ransomware!\" gang. Looking through the file we can see that it is not completely encrypted. Based on the ZIPDIRRECORD we can make out that there are several TXT files present. This could mean that only the ZIPFILE records are encrypted. Additionally, we know that the gang uses a weak cryptographic design for their ransomware, so it shouldn't be hard to break once we understand how it works.","At the end of the file, we see the following comment that also contains some markers:","It appears that the malware tries to split the file into several blocks and then encrypts them. Since we know that only part of the Zip file was encrypted, we can assume that the 10 blocks start every 832 bytes and are probably only encrypted up until the first 256 bytes.","One weak encryption method is XORing the data with a key. Based on the information we have, we can try to derive the original XOR key that was used to encrypt the files. We just need to find some plaintext bytes from the original file and then do a Known-Plaintext-Attack (KPA) on the XOR."]},{"l":"Identifying Plaintext","p":["A Zip file usually contains local file headers with information about the file such as the comment, file size, file name, optional \"extra\" data fields, and then the possibly compressed or encrypted file data. The ZIPDIRRECORD also contains some of this information (i.e. the file name).","To perform a KPA we need enough plaintext, longer than the key used to encrypt the file, to decrypt it. The local file header has the following structure:","We know that inside the zip file we have several TXT files with names like report-1.txt, report-2.txt and so on until report-10.txt. This information is useful to reconstruct the header. If we take for example the first filename, then we can create a plaintext with the following bytes.","This header means that the file name length is 12 ( 0C 00 in hex), has no extra data field (hence 00 00 in hex) and has the filename report-1.txt.","We can now try to do a KPA attack on the encrypted blocks and the plaintext using [this tool]( DidierStevensSuite/xor-kpa.py at master · DidierStevens/DidierStevensSuite · GitHub) from Didier Stevens.","The tool tells us that no key is found, meaning we have to increase our plaintext size. Looking back at how the local file headers usually look like, the filename commonly follows with an extra field ID 0x5455 which is a UTC Unix timestamp. We could also try adding this to our plaintext to increase its size a bit.","Running the tool again will give us a potential key.","We can again create a new file for the key."]},{"l":"Decryption","p":["We can now decrypt the file by applying the XOR with the key we found on the first 256 bytes for every block. First, we need to split the original encrypted zip file so we can more easily extract the encrypted data.","This will generate 14 files with a size of 832 bytes but we can remove the last 3 files and everything after the METADATA of the 11th file, since this doesn't contain any encrypted data. We should now have 10 encrypted blocks numbered from 0x00 to 0x09 where the first 256 bytes are encrypted. We perform the KPA only on the encrypted bits with the key. Next we will append the unencrypted part of the file to the end of it.","Repeating this for all the files and reassembling them gives us the original zip file. When we open it we can find the flag inside report-1.txt."]}],[{"l":"Hack The Boo 2023 - Forensics and Web","p":["For this years halloween I decided to participate in the Hack The Boo CTF competition from Hack the Box. Despite this being my first solo public CTF competition, I still managed to climb to leaderboards and reach top 50 (48th to be exact). In total I managed to capture 7 out of the 10 flags, some easier than others. In this post I will delve into how I managed to solve the forensics and web challenges, as those where the areas my skills stuck out the most."]},{"l":"Forensics - Trick or Treat"},{"l":"Description","p":["Another night staying alone at home during Halloween. But someone wanted to play a Halloween game with me. They emailed me the subject \"Trick or Treat\" and an attachment. When I opened the file, a black screen appeared for a second on my screen. It wasn't so scary; maybe the season is not so spooky after all."]},{"l":"LNK File","p":["We start our investigation by analyzing the .lnk file with exiftools by executing exiftools trick_or_treat.lnk on the file. Inside the file information we find something strange:","Let us take some time to analyze the behavior. The script first selects a random User-Agent from the crafted $UserAgents array. It then uses a WebClient to download the contents of the specified URL ( http://windowsliveupdater.com) and decodes the obfuscated file as follows:","This essentially performs an XOR operation with 0x1d on every character in the downloaded file. This information might be useful later on in our investigations. Now lets proceed with the PCAP file."]},{"l":"PCAP File","p":["Inside the .lnk file we found that a request was made to a fake windows updater url. Looking at the .pcap file and searching for the domain, we find that the IP address leads to 77.74.198.52. We select one of its requests and follow the HTTP stream. One of the packets contains a giant blob of random text:","It looks like an encoded string and we know that we have to decode it with the XOR function we found previously. Now there are several ways to solve this. Either we use CyberChef and apply the XOR operation, or we can run the script ourselves in the tool from TryItOnline by replacing the $vurnwos variable with the above string. Either way we retrieve the decoded script:","Inside we find our flag as the DropBox AccessToken."]},{"l":"Forensics - Valhalloween"},{"i":"description-1","l":"Description","p":["As I was walking the neighbor's streets for some Trick-or-Treat, a strange man approached me, saying he was dressed as \"The God of Mischief!\". He handed me some candy and disappeared. Among the candy bars was a USB in disguise, and when I plugged it into my computer, all my files were corrupted! First, spawn the haunted Docker instance and connect to it! Dig through the horrors that lie in the given Logs and answer whatever questions are asked of you!"]},{"l":"Sysmon Analysis","p":["For this challenge we are given some Windows Event Logs. For dealing with .evtx files on Linux we can use an EVTX Parser. We are only interested in the Sysmon logs so","Alternatively, we can also use Chainsaw to quickly hunt for Windows Artifacts:","Now we can more easily search through the event log. Let's connect to the docker instance and try to answer some questions.","Because we need to find where the ransomware came from, we can search for the string http://. In one of the results we can see that a command has been triggered:","This reveals that the ransomwhere was downloaded from 103.162.14.116:8888.","From the issued command, a process is started with the name mscalc.exe. To find where this program has been launched we can look for this name in the Image field of the logs. Then looking at the Hashes field, we can find the MD5 hash to be B94F3FF666D9781CB69088658CD53772.","A quick search on VirusTotal shows that we are dealing with the LokiLocker ransomwhere.","Seaching for schtasks we can again find that a command has been run. This command shedules an ONLOGON task with the name Loki.","We can look for when the process is started by searching for start-process. The first Event that runs the malicious program executes it via powershell.exe with a process ID of 3856.","Following the PPID we find that the command is issued inside the C:\\Users\\HoaGay\\Documents\\Subjects folder. Searching for this directory we can find all the documents that were opend by this user. After opening the document C:\\Users\\HoaGay\\Documents\\Subjects\\Unexpe.docx we see that the initial download stage begins.","This can be found in the UtcTime field of the previous event. After submitting all these answers, we get the flag and have solved the forensics challenges."]},{"l":"Web - HauntMart"},{"i":"description-2","l":"Description","p":["An eerie expedition into the world of online retail, where the most sinister and spine-tingling inventory reigns supreme. Can you take it down?"]},{"l":"Browsing the website","p":["Looking through the website we can register with an account. After logging in the only functionality seems to be the sell products page. On this page we add products to the site that gets reviewed by the moderators. What stands out here is the 'manual' field where we can specify a link to a product. Lets dig into the source code a bit."]},{"l":"Source code analysis","p":["In the index.html file we see that if we have the admin role, we can see the flag.","Now how can we get the admin role? Well, conveniently there is a function called makeUserAdmin being used in the /addAdmin endpoint. Looking in the util.py file we see that the downloadManual(url) function does some simple checks against the url we put in.","This merely checks if our string includes the strings in the blocked_host array and can be bypassed by url encoding our input. Next the function will send a request to fetch a file that comes after the last / character. The trick is to make this function make a request to the /addAdmin endpoint with our username as one of the request parameters."]},{"l":"Exploiting the Vulnerability","p":["By analyzing our request with the docker container we can more easily see if our requests fail or not. Let's firs try to use the following request parameters:","We see that we are able to make a successful submission but in the responses we see that we get a file not found error:","This means the requested endpoint is not found. We have to target the /api/addAdmin endpoint and try again. After updating the parameter, we can successfully add us as an admin user with the following request:","After logging out and logging back in, we are given the flag on the home page."]},{"l":"Web - Ghostly Templates","p":["This challenge really reminded me of an earlier challenge that I solved on the HTB platform, namely RenderQuest. This challenge follows a similar approach with some few alteration."]},{"i":"browsing-the-website-1","l":"Browsing the Website","p":["Taking a look at the functionality of the website, it allows us to use their golang templates on our own webpages. Gus Ralph has made an excellent blog post about SSTIs in Go's builtin html/template module. This discusses the vulnerabilities that can arise when using said templates.","The essence of the vulnerability lies in the fact that we can call any method through template injection from the source code, as long as the method is an attribute of the value passed to the template. Lets give the source code as an example here:","The first function cannot be injected as it is not passed an attribute of the template that we can use. The second function however is vulnerable. I specifically chose this function as it reads a file from the server and returns its content. This means that we can read any file we want on the server."]},{"i":"exploiting-the-vulnerability-1","l":"Exploiting the Vulnerability","p":["Now to exploit the vulnerability, we of course need to host a website that implements the given templates. Luckily, Go provides its own playground for testing code that we can use. Lets make a simple website that uses one of their templates and see the responses.","This page simply renders all the templates we have available to us, but we can equally call a simple template like .ServerInfo.Hostname. As discussed previously, our job is to read a file from the server (flag.txt). Lets adapt our page:","This page will call the OutFileContents() function from the main.go file and pass in our UserAgent as a parameter. Now why not just pass in the file we want to read? Well, since the function expects an argument of type RequestData, so we might not be always able to pass it a string. We will have to modify our UserAgent when sending our request. We can either do this with BurpSuite, but a simple curl can also do the trick:","We have found the flag."]},{"l":"Conclusion","p":["These small challenges, although rated as easy by the developers, did caught me off guard sometimes. Overall I learned quite some new things and had great fun in solving the challenges. Big shout out to Hack The Box for organizing this event!"]}],[{"l":"HTB University CTF 2023: Brains & Bytes"},{"l":"Forensics: One Step Closer (Easy)"},{"l":"Description","p":["Tasked with defending the antidote's research, a diverse group of students united against a relentless cyber onslaught. As codes clashed and defenses were tested, their collective effort stood as humanity's beacon, inching closer to safeguarding the research for the cure with every thwarted attack. A stealthy attack might have penetrated their defenses. Along with the Hackster's University students, analyze the provided file so you can detect this attack in the future."]},{"l":"Vaccine File","p":["We are given a vaccine.js file that contains some malicious obfuscated JS code. Two function are never used inside the script, so we can remove them. After renaming some variables we can figure out what the remainder of the script is doing:","The script will download a VBS file, save it in a temp folder and execute it. The malicious file is coming from http://infected.human.htb/d/BKtQR. After startup up the docker instance and adding the domain to our host file, we can download this file to our machine.","This file contains a large amount of obfuscated data. Some variables that are never reused are removed so that we can better understand the script:","After doing the required replacements in the code we get something like this:","The Base64 data decodes to:","The script downloads an image from http://infected.zombie.htb/WJveX71agmOQ6Gw_1698762642.jpg and decodes the Base64 data inside the markers. We can download the image from the previously found link and decode the final part between BASE64_START and BASE64_END.","By decoding it we can get the flag at the end of the string."]},{"l":"Fullpwn: Apethanto (Easy)"},{"i":"description-1","l":"Description","p":["Apethanto is an Easy Linux machine hosting a Metabase instance that is vulnerable to pre-authentication Remote Code Execution (RCE). By finding the exposed setup-token, the attacker leverages the vulnerability to obtain a reverse shell on the target. Once the attacker gets a shell on the remote machine as the user metabase he may notice that there is a cron that executes sudo apt update from a different TTY terminal. This means, that the user metabase has an active SUDO token. Since the user belongs to the sudo group, the attacker is able to steal the valid SUDO token in order to get root privileges."]},{"l":"Enumeration","p":["The scan output informs us that Nginx and SSH are the only available services listening on port 80 and 22 respectively, and we get redirected to apethanto.htb when visiting the website on port 80. Let's add this to our hosts file.","The page appears mostly static, but hovering over the \"For Doctors\" hyperlink or inspecting the site's source code reveals a hyperlink to a metabase virtual host, which we can add to our hosts file.","Browsing to the discovered virtual host, we find a login prompt for the Metabase service:","metabase-login","With no credentials and nothing else to go by, we start researching recent vulnerabilities discovered in Metabase. A search for the keywords metabase vulnerability cve leads us to various CVE repositories that list an array of CVEs for the service."]},{"l":"Foothold","p":["Searching for that particular CVE leads us to a public PoC. Since this PoC uses burp suite collaborator, we can create our own script based on this PoC. To start, we need to get the setup_token from our target. Next we define another function that will send our payload. Our final exploit script looks like this:","Don't forget to change the command to make a reverse shell connection to your IP. Start a netcat listener on port 443 and run the script:","We instantly get a callback on our listener:","We now have a shell as the metabase user. The user flag can be found at /home/metabase/user.txt."]},{"l":"Privilege Escalation","p":["The only thing that stands out is that we are part of the sudo group.","Looking around the web for more information, we find this project. We copy exploit_v3.sh from the repo to our target. Then, we make it executable and execute it.","It might not work the first time if the SUDO token is expired, so after a few tries it should give us a root shell."]}],[{"l":"LakeCTF 2023 - Scream Into The Abyss"},{"l":"Challenge","p":["We are given the following files:","nc chall.polygl0ts.ch 9001","abyss_scream","Dockerfile","Lets see what we are dealing with and list the protections that are enabled:","Source code of main and save_msg functions.","When we run the program and enter x, we get into the save_msg function that contains both a buffer overflow and format string vulnerability that we can exploit to execute system(/bin/sh) and read the flag on the file system."]},{"l":"Finding the Offset","p":["We can create a cyclic pattern and calculate the offset to our return address. Lets open GDB and enter our payload after it asks us to input our message. Because the binary does a call to system(date), we can't debug after this call and have to jump past it. First we disassemble the save_msg function to find where we can set a breakpoint.","We will set a breakpoint right before the system call and then jump to save_msg+154:","Now we can enter our cyclic pattern in the prompt and inpect the RSP to calculate our offset:"]},{"l":"Testing our offset","p":["Next we can confirm that this is the right offset by creating a small python script that puts 0xdeadbeef at our found offset.","Demonstrating that it works:"]},{"l":"Leaking Addresses","p":["Because of the format string vulnerability we can leak addresses of the stack. Lets create a small fuzzing script that will loop through several leaked addresses to see if we find interesting addresses.","We try looking for addresses starting with 0x55, and we find a few that might be useful:","We inspect them in gdb one by one and come to the following conclusions:","Based on this information we can calculate the address of main and the address of our input buffer. The latter can be used to store our string to /bin/sh\\x00. We add the following to our exploit script:","With this code we can calculate the pie base address:"]},{"l":"Finding useful instructions","p":["We will need a pop rdi and ret gadget that we can find in gdb or with ropper. The reason fo the ret gadget is that when we perform our buffer overflow, we have to realign the stack before continuing our chain. When ret is invoked, it increments $rsp by 8. Thus, you can simply add a dummy ret to make $rsp 16-byte aligned."]},{"l":"ROP Chain","p":["We can now use both gadgets to set the first argument of the system function with the address of /bin/sh, and then call the system function."]},{"l":"Final Exploit","p":["Here is the final exploit script that executes our ROP chain with all the required addresses.","And when executing the script we get a shell:"]}],[{"l":"Jeeves (Easy)"},{"l":"Synopsis","p":["Today we take on a simple binary exploitation challenge from Hack The Box. In this post we are going to solve the Jeeves Pwn challenge from the Intro to Binary Exploitation track."]},{"l":"Running the program","p":["We start off by running the program normally. We are given a prompt asking for our name.","The program subsequently prints a greeting message back to us. Based on this response alone, we can assume that our input is stored somewhere in a buffer."]},{"l":"Examining the binary with Ghidra","p":["Let's decompile the binary using Ghidra so that we can better understand its inner workings. After importing the binary we can analyze the main function:","The user input is stored inside the input buffer with a size of 44 bytes. We also see there is a flag.txt file that gets opened after the if-statement that verfifies if the check variable is equal to the value 0x1337bab3(or in other words 'leetbabe'). However, this check is never going to succeed because the check variable is initialized in a different way. We therefore need to find out how to overwrite this variable on the stack.","The assembly view in Ghidra shows this variable is given the hex value of 0xdeadc0d3(since this is indeed just dead code).","ghidra"]},{"l":"Examining the binary in GDB","p":["Loading the binary into GDB and disassembling the main function we get the following output:","Our task is to figure out how many bytes we have to overflow the buffer in order to overwrite the check variable. Lets's set a breakpoint right after the gets call and run the program (just enter some A's as our input):","Looking at the RIP (Instruction Pointer) above, we can see that it is comparing dword ptr [rbp - 4] with 0x1337bab3. Let's have a look at the value of rbp-4 in GDB.","To see what happens when we change this variable, we can try to change it using pwndbg and continue running the program. Pwndbg is just a handy GDB plug-in that makes debugging with GDB easier for reverse-engineering tasks.","Looking at the output we can see that if we are able to change the variable to 0x1337bab3, we receive a small gift. This is probably the flag we are looking for."]},{"l":"The Exploitation","p":["Using python3 we can find the offset by generating a pattern and running the program with this input. To make our lifes a bit easier, we can do this with the pwntools package as follows:","We run the program again with the created pattern and inspect rbp-4:","We see that the variable now gets overwritting with paaa. Finding the offset is as easy as just using the cyclic_find function from pwntools:","So our final payload will be: A*60 + 0x1337bab3."]},{"l":"Crafting our payload","p":["Now we have all the information to craft our payload.","Or we can run it directly in GDB to test our payload first:"]},{"l":"Executing our payload on the target","p":["Here we will show 2 ways of executing our payload. The first method is a manual approach, while the other is a more automated way using pwntools."]},{"l":"Method 1 (manual)"},{"l":"Method 2 (pwntools)","p":["Running our exploit code:","After running our exploit, we indeed get the flag back. We have successfully completed our first pwn challenge in the Intro to Binary Exploitation track."]}],[{"l":"Administrator (Medium)"},{"l":"Synopsis","p":["Administrator is a medium-difficulty Windows machine designed around a complete domain compromise scenario, where credentials for a low-privileged user are provided. To gain access to the michael account, ACLs (Access Control Lists) over privileged objects are enumerated, leading us to discover that the user olivia has GenericAll permissions over michael, allowing us to reset his password. With access as michael, it is revealed that he can force a password change on the user benjamin, whose password is reset. This grants access to FTP where a backup.psafe3 file is discovered, cracked, and reveals credentials for several users. These credentials are sprayed across the domain, revealing valid credentials for the user emily. Further enumeration shows that emily has GenericWrite permissions over the user ethan, allowing us to perform a targeted Kerberoasting attack. The recovered hash is cracked and reveals valid credentials for ethan, who is found to have DCSync rights ultimately allowing retrieval of the Administrator account hash and full domain compromise.","As is common in real life Windows pentests, you will start the Administrator box with credentials for the following account:"]},{"l":"Reconnaissance","p":["From our initial nmap scan, we see that we are dealing with a Windows Domain Controller. Notice that port 21 (FTP) is also open.","We are given a domain user account with the following credentials: olivia:ichliebedich. Further enumeration reveals that this account has the PSRemoting privilege set."]},{"l":"BloodHound Enumeration","p":["We can either logon to the DC with Evil-WinRM and run SharpHound to collect information for BloodHound or run the BloodHound.py script.","We now start BloodHound CE and import the zip file. After looking through the data, we see that we have a path from olivia to benjamin. Now benjamin is a member of the Share Moderators group, so we might get more access after comprimising his account."]},{"l":"User","p":["As our starting account, we have the GenericAll permissions to the user michael. There are several ways we can abuse this privilege: we can either change the user's password or set an SPN on the account and perform a targeted Kerberoasting attack. Let's go for the latter as for the next user we already have to force a password change."]},{"l":"Fixing Clock Skew","p":["If you get a Clock skew too great error just like me, just run this command that spawns a bash shell with the clock synced to the DC:","So now we can get the hash, copy it to a file and run hashcat to crack it.","However, we are not able to crack the hash so let's proceed with the second method and reset the password for the user account. I will also immediately reset the account for Benjamin and check what access we have. From Linux we can use the net rpc command.","Looks like we don't have any additional permissions on the SMB shares, so let's try the FTP share we found earlier."]},{"l":"Cracking PSafe Database Credentials","p":["Bingo! We are logged in on the FTP share and find a psafe3 backup file.","The backup file protected by a password, but we can decrypt it using JohnTheRipper.","With the password of the database, we can now use pwsafe3 and see what is stored inside.","We find the password for three users.","We can now log into the DC as Emily and grab the user flag."]},{"l":"Root","p":["Emily also has GenericWrite access to Ethan. We can therefore perform the same attacks as before and perform a targeted Kerberoast attack.","From the BloodHound data we see that ethan has the DS-Replication-Get-Changes and the DS-Replication-Get-Changes-All permission on the domain ADMINISTRATOR.HTB."]},{"l":"DCSync","p":["We can perform a DCSync attack after compromsing his account. Let's proceed!","We have sucessfully compromised the domain and can now grab the root flag."]}],[{"l":"Blazorized (Hard)"},{"l":"Synopsis","p":["Blazorized is a Windows machine, starting with a website written using the Blazor .NET framework that allows downloading a DLL file that can be reverse engineered to find a JWT secret and use it to get access to the admin panel. The admin panel is vulnerable to an SQL injection to get code execution. To pivot to the next user, the WriteSPN privilege can be abused to perform a targeted Kerberoast attack on another user. The targeted user is able to write a logon script that ultimately gives access to a user that allows performing a DCSync attack on the domain."]},{"l":"Reconnaissance","p":["Starting with an nmap scan, we see that the host is a domain controller and redirects us to blazorized.htb.","We add the domain to our /etc/hosts file and continue to enumerate the website. On the website we notice that it is built using Blazor WebAssembly. One feature of the site is to request all posts and categories from the API at /check-updates.","Check for updates","This function makes a request to api.blazorized.htb so we add this to our host file as well. Intercepting the request in BurpSuite, we see that an authorization token is passed.","Check for updates API call"]},{"l":"JWT Token Forging","p":["We can decode the JWT token with jwt.io:","Another thing to note is that when refreshing the website and intercept our requests, a GET request is made to /_framework/blazor.boot.json. We can try to extract the .dll files from the Blazor application by doing a curl command at this endpoint. This will list all loaded dll files by the application."]},{"l":"DLL Reversing","p":["After looking at the files one by one and decompiling them using dnSpy we find something interesting for the Blazorized.Helpers.dll in the function JWT.","Within the decompiled dll there is a jwtSymmetricSecurityKey along with several other variables, one of which is an endpoint to the administrator dashboard. We can add this to our hosts file as well."]},{"l":"User","p":["With the found JWT secret and admin subdomain, we can generate a new JWT token with the following payload and using the signature we found (make sure to increase the expiration to make the token valid for a longer period).","There are several ways to forge another JWT token with the secret we just acquired. The easiest method is to again use jwt.io and inset the secret in the signature field.","Now you can copy the JWT token and import the token into the browser by creating a new item in Local Storage with the key set to jwt and the token as the value. Then navigate to http://admin.blazorized.htb and refresh the page to login."]},{"l":"SQL Injection","p":["The Super Admin Panel allows managing posts. One feature is looking for duplicate post titles that is vulnerable to blind SQL injection. This can be verified by the following payload:","This will wait for 5 seconds before executing the query. Now that we have verified that we have an SQL injection, let's explore what we can do with this. We can try to upload a Netcat binary onto the host to get a reverse shell with xp_cmdshell. We first have to enable this transaction in order to use it:","We receive a notification confirming that the command executed without any errors.","Now lets try to get a reverse shell. We start by hosting the nc.exe binary with a Python webserver, start a netcat listener and then executing the following queries:","After executing the payload we get a shell as nu_1055 and can grab the user flag on their desktop."]},{"l":"Root","p":["On the machine we see two additional users ( RSA_4810 and SSA_6010)."]},{"l":"BloodHound Enumeration","p":["Since this is a domain controller and we are a domain user, we can run SharpHound to get more information about the users in the domain and what permissions they have.","We wait for the SharpHound tool to finish and then transfer the ZIP file to our machine.","It might be necessary to extract the json files from the ZIP file and converting it to a correct JSON format (using jq). Checking out our results in BloodHound, we see that the user NU_1055 has the ability to write to the \"serviceprincipalname\" attribute of the user RSA_4810, therefore we are able to perform a targeted kerberoast attack."]},{"l":"WriteSPN Abuse","p":["We can copy PowerView onto the host and perform the attack from Windows.","We get back the krb5tgs hash of the RSA user and can crack it offline.","The password of the user is (Ni7856Do9854Ki05Ng0005 #)."]},{"l":"DACL Abuse","p":["We can now login with Evil-WinRM.","We look for ACLs that can be abused using PowerView.","We find one ACL for our current user that shows a WriteProperty on the script path of the SSA_6010 user. By having this permission it could allow us to write a custom logon script that executes whenever this user tries to login to the machine. We can look if this user tried to login:","It looks like this person is logging in and out every minute so lets abuse this now. We are able to write a bat file in sysvol\\[domain]\\scripts\\ and use this to run a reverse shell whenever the user SSA_6010 tries to login. We can check which logon script folder is from our target user by checking the permissions.","We wait a minute for the user to login and catch our reverse shell. From BloodHound we also see that this user is able to perform a DCSync attack."]},{"l":"DCSync","p":["We upload mimikatz.exe and perform the attack and get the hash of the Domain Admin."]}],[{"l":"Checker (Hard)"},{"l":"Synopsis","p":["Checker is a hard-level Linux machine running Teampass and Bookstack on separate ports. The Teampass version has a SQL injection vulnerability CVE-2023-1545 that can be exploited to obtain user password hashes. By cracking these hashes, we get the password for the Teampass user bob. Logging into Teampass reveals credentials for both Bookstack user bob and the SSH user reader. Attempting SSH login as reader user shows that two-factor authentication is enabled. Meanwhile, the Bookstack version is vulnerable to CVE-2023-6199, a local file read flaw via Blind SSRF, which can be exploited to retrieve the 2FA secret key for the reader user’s SSH account, enabling successful SSH login. We reverse engineer a binary for privilege escalation to root to discover a command injection vulnerability, which we then exploit using a custom script."]},{"l":"Reconnaissance","p":["From our nmap scan we see three ports are open: 22, 80, 8080."]},{"l":"Foothold","p":["The main website on port 80 redirects to checker.htb that makes use of BookStack, a simple, self-hosted, easy-to-use platform for organising and storing information.","On port 8080, a Teampass instance is running. Since we don't have any credentials yet, we start searching online for disclosed vulnerabilities. Searching for teampass on https://security.sneak.io shows several results, one of which is an SQL injection vulnerability that allows us to retrieve two users from the Teampass database.","Only Bob's password is crackable with Hashcat."]},{"l":"User"},{"l":"Teampass","p":["We can login to the Teampass instance by changing the time and using the credentials on checker.htb:8080 that we found earlier. One of the buttons redirects us to vault.checker.htb so we can also add this to our /etc/hosts file. Clicking on the Password tab, we see two items for our user.","We can just click on the names of the items to open them.","Clicking on the eye icon reveals the password of the BookStack login. The other ( ssh access) also reveals SSH credentials for the user reader. This will probably be a user on the machine."]},{"l":"BookStack","p":["We can now login to the Bookstack website as bob@checker.htb. After logging in we see that the admin user has created some books and pages.","We don't know the exact version of the website, but after searching around the web we can discover CVE-2023-6199 which allows filtering local files on the server. This is possible because the application is vulnerable to SSRF. We can check if this site is vulnerable to the attack described by Fluidattacks.","With writer permissions, we can create a book and create pages. Such pages accept Markdown and HTML code. We can intercept the save draft function with burpsuite. The blog post talks about using the php_filter_chains_oracle_exploit in order to read files on the server. The idea of this attack is the following:","Use the iconv filter with an encoding increasing the data size exponentially to trigger a memory error.","Use the dechunk filter to determine the first character of the file, based on the previous error.","Use the iconv filter again with encodings having different bytes ordering to swap remaining characters with the first one.","The Oracle exploit works with url encoded requests, but as we can see in BurpSuite we are sending JSON requests. In order to make the exploit work, we have to changed the Content-Type to application/x-www-form-urlencoded. We run the exploit as follows:","The above command fails with several errors about encoding problems. We redirect our request to BurpSuite with the --proxy argument and inspect the requests that are made.","If we follow along with the video in the PoC, our html parameter has to be in the format of img=src='data:image/png;base64,BASE64_PAYLOAD' /. We will have to make some modifications to the script. If we go to filters_chain_oracle/core/requestor.py we can modify line 108 to base64 encode our payload and add the required img tag.","We can now run the exploit script again and should be able to read files from the server. The correct request will look something like this:","For instance we can verify the version of the BookStore application by targeting ../version(version=v23.10.2).","Since this process is very slow, we need to find good useful files to read on the server. I leaked the /etc/passwd with offset 1394 to get the users on the machine (but we alread knew reader was a user). I also tried to leak the .env file at the root of the application, but these credentials where not very useful."]},{"l":"MFA Token","p":["We can login via SSH using the reader user and the password hiccup-publicly-genesis, but it asks for an OTP code. An article on how to setup multi-factor authentication on SSH describes using Google's PAM. The section on Recovering Access it talks about a secret key in the user's home folder at /home/USER/.google_authenticator. This secret key can be manually type it into an TOTP app to get the rotating codes.","The problem is that we don't have access to the home folder of reader. After being stuck for a while, the admin user also posted a page about basic-backup-with-cp where it makes a copy of the user's home directory in /backup/home_backup.","I tried to see if there was a backup of this user's home folder at /backup/home_backup/home/reader and here I was able to leak the TOTP_AUTH token.","We can use this key on https://totp.danhersam.com to generate the token.","We can now login to the machine and get the user flag."]},{"l":"Root","p":["We are able to run /opt/hash-checker/check-leak.sh * as the root user."]},{"l":"Script analysis","p":["We can try a few users and only bob makes the script run.","When executing the script, we run pspy in another shell."]},{"l":"Command Injection","p":["The binary runs a shell command that is vulnerable to command injection if we are able to alter the pw value. We first need to see what the contents of the shared memory is. I asked ChatGPT how we can read from a shared memory location, and it gave me a small C script to start with.","Prompt: How can you read from a shared memory location on Linux based on the key?","For this script to work, you would need to know the SHM_KEY value, but this is not a fixed location. We will do the following modifications:","Randomly generate key values and run the script in a loop","When the shared memory location is not empty, print the contents and break out of the loop","We compile and run the script and then run the check-leak.sh command as root in another shell.","The leaked memory contains the password of bob, as we expected. So in order to exploit this we need to overwrite the shared memory location (replace the password hash with injection payload). We can see that the password hash is captured after the sign, so this is the place where we can place our command injection payload. Our final exploit will copy /bin/bash to /tmp and add the setuid bit to it.","Lets compile and run it again.","The exploit worked and now we can get the root flag."]}],[{"l":"Infiltrator (Insane)"},{"l":"Synopsis","p":["Infiltrator is an Insane Windows Active Directory machine that starts with a website that an attacker can scrape for possible usernames on the machine. One user doesn't have Kerberos pre-authentication enabled, and his password can be cracked. Afterwards, an intricate attack chain focused on Active Directory permissions allows the attacker to get access to the machine over WinRM as the user M.harris. Once on the machine, the attacker can identify that the whole company communicates through the Output Messenger application. Infiltrating the application, switching users, reverse engineering a binary, and using the application's API, he can eventually land a shell as the user O.martinez on the remote machine. Afterwards, he discovers a network capture file with a backup archive and a BitLocker volume recovery key. Unlocking the volume, another backup folder contains an ntds.dit file from which he can read sensitive user information and find a valid password for the user lan_managment. This new user can read the GMSA password of the user infiltrator_svc$. This last user can exploit a vulnerable ESC4 certificate template. Finally, he can get the Administrator's hash and compromise the whole domain through the certificate exploitation."]},{"l":"Enumeration","p":["I ain’t wastin' time with your granddaddy’s nmap scan — nah, we already know this box be bustin’ that Active Directory life, so we skip the foreplay and go raw into user enumeration. First, we rip a list of names straight off the company site like it’s LinkedIn recon but with zero professionalism and maximum goblin energy (we be lootin').","Now we feed these names into UsernameAnarchy— a beautiful little gremlin of a tool that chews on names and vomits out 6,000 permutations of corporate identity theft.","And just like that, we got a whole buffet of usernames. Next up: Kerbrute, because what’s more fun than whispering sweet nothings to Kerberos and seeing who moans back?","Alright, we cracked the username code, and yeah, we could spam it with name lists like a desperate Tinder bot, but tossing in j.smith-x98800.txt was a total flop. So, we’re calling it: this is our final crew.","Time to get greasy with ASREPRoasting. We send a lil’ love letter to the domain like “hey, gimme them sweet sweet hashies” — and boom, one account responds like “sure babe, no pre-auth needed!”. Yessir!","Turns out our girl l.clark out here just raw-dogging Kerberos with no protection. Naturally, we hit her with the ol’ hashcat special:","This hash be cracking faster than a microwave burrito — and what do we get? That’s right, keys to the kingdom. VIP access. L.clark got us in the door, and now we’re poking around like we own the place.","With these creds on our hands, we blast nxc smb again and go full snoop-mode on the domain — enumerate all the users like it’s roll call at hacker high school. We also run a cheeky lil' SID lookup:","We flex for a Kerberoasting round just in case someone slipped, but nah, nothing juicy. No tickets, no service accounts, just disappointment. But hold up — plot twist. Our recon pulls up a lil’ easter egg: user k.turner has a password just chillin’ in their description field. Man’s out here treating Active Directory like a Post-it note.","So we take this blessed gift from k.turner’s description field and we yeet it into a password spray like we’re Oprah handing out creds:","“You get a login! YOU get a login! ERRBODY LOGGING IN!”","But then... Curveball. We see that both m.harris and d.anderson get the message STATUS_ACCOUNT_RESTRICTION. Excuse me??? Microsoft really out here like:","“Woah woah woah, hold up... you do have the right password, but uhh... no entry. Try again when your chakras are aligned or whatever.”","This ain't a wrong password, nah. This is “you got it, but you still ain't allowed.” That’s the cyber equivalent of your key working in the lock but some dude inside just holding the door shut whispering, “not today, boi.”","So yeah — creds probably valid, but maybe they’re disabled, locked out, got logon restrictions, or just spiritually unavailable. Either way, these accounts are on some ✨emotional boundary✨ arc and we gotta pivot."]},{"l":"Bloodhound","p":["So now that we got creds for l.clark(shoutout to my boy k.turner), we unleash BloodHound to sniff out the domain like a digital truffle pig.","We throw that juicy ZIP into BloodHound-CE like it’s an offering to the graph gods — and lo and behold, our good sis l.clark is chillin’ with the Marketing Team. Nothing too spicy yet, but wait... The Chiefs Marketing group has the ForceChangePassword on the user M.Harris. That's a bingo!","Meanwhile, d.anderson still out here on that NTLM ain’t my vibe energy — he’s vibing strictly in Kerberos-only mode. Man's spiritually allergic to NTLM. But lucky for us, we speak fluent Kerberos. So we flex with getTGT.py, praying to the Impacket gods for a valid TGT:","And BOOM — it worked. Password valid. Ticket secured. Identity stolen. Heist soundtrack intensifies. Then we casually log in like we’ve been d.anderson this whole time:","But hold up... BloodHound whispers in our ear again: “psst... d.anderson got GenericAll over the Marketing Digital OU...”","Okay now we’re cooking. You know what that means? We can start yeeting ACLs around ike we’re modding the Minecraft server at 3AM.","“You get admin perms, you get admin perms—oh look, the economy’s ruined!”","So we bless our old pal l.clark with GenericAll over the entire OU using bloodyAD:","That’s it, l.clark just went from running marketing reports to rewriting destiny. Let the ACL shenanigans commence."]},{"l":"User","p":["Now that we’ve yeeted GenericAll onto the OU like it’s a cursed enchantment, our permissions have trickled down to lil’ e.rodriguez too. BloodHound’s over here grinning like:","“Congrats, you just unlocked the side quest to m.harris.”","So how do we get spicy with this? We’re about to hit e.rodriguez with Shadow Credentials—basically stuffing a fake cert into his account like it’s a USB Rubber Ducky in a coffee shop laptop.","This lets us Pass the Certificate using PKINIT, snag a TGT, and suddenly we’re e.rodriguez now. It’s like Face/Off but for Active Directory. Kerberos never saw it coming.","Having obtained the TGT, we can conduct an UnPAC-the-hash to recover the NT hash of the target account.","Boom, we just snagged the NT Hash of e.rodriguez like a digital pickpocket in a hacker’s convention. Now it’s time to boss up and slap this user into the CHIEFS MARKETING group — because who doesn’t wanna be a marketing chief.","While we’re at it, we’re gonna force poor m.harris to change their password faster than you ghost your ex. But first, don’t forget to pimp out your /etc/krb5.conf file with the right settings or Kerberos will just laugh at you like you showed up to a sword fight with a butter knife.","If you are not a scrub like me, you could have just generated this with nxc.","Now we add ourself to the target group and force a password change.","Since m.harris is playing the protected user card like he the president of Active Directory, we gotta do the whole “request a TGT and flex Kerberos auth” dance again.","No password? No problem — just slide into Evil-WinRM using the magic --realm flag with your shiny ticket instead of a boring old password. It’s like showing up to the party with a golden invite while everyone else is stuck outside sweating their creds."]},{"l":"Root","p":["After logging in, we find a few zip files in C:\\ProgramData\\Output Messenger Server\\Temp. Inside the OutputMessengerMysql.zip we find a OutputMysql.ini that contains a password for port 14406."]},{"l":"Unintended Path","p":["Since the database is running with admin powers like it’s the kingpin of this system, we just casually port-forward that juicy MySQL on port 14406 and grab the root flag like a boss. Dropped Chisel on the target because who doesn’t love a good reverse tunnel flex?","Easy mode activated — root flag, served on a silver platter. Now buckle up, because it’s time to dive into the actual intended way to get root. Spoiler: it’s not this chill."]},{"l":"Intended Path (Windows Client needed)","p":["From here on out, we’re hopping into a Windows VM because… well, reasons. Spoiler alert: it gets messy and way more fun. If you still have the TGT ticket for m.harris chilling somewhere, just yank it over and convert to a Kirbi file like a pro hacker. But nah, I’m gonna show you how to climb back up from e.rodriguez to m.harris— Windows style.","If you get hit with that annoying KRB_AP_ERR_SKEW (Clock skew too great) error, it means your VM clock is throwing a tantrum and isn’t synced with the domain controller. Fix that before joining the domain — otherwise you’re in for a world of pain and might need to do a time travel rollback.","First we will download the bloodAD.exe compiled binary and run the following commands:","Next up, before Kerberos can party on our Windows attack VM, we gotta join it to the domain. Hop into: Settings Accounts Access work or school Connect. Punch in infiltrator.htb as the domain and log in with any domain account (e.g. l.clark).","Another pro tip: Make sure your VPN interface’s DHCP server points to the DC IP (10.10.11.31), otherwise Kerberos throws a hissy fit.","If it asks to add an account, just politely decline. Restart your VM, sign in as a local user, and don’t forget to slap that firewall off — this isn’t a hotel lobby.","Next we can convert the ccache file to Kirbi and inject our ticket into memory using Rubeus.","Aight we’re in. Since m.harris got that sweet Remote Management privilege, we Kerberos-yeet ourselves into a WinRM shell like some kind of enterprise wizard. Once inside, it’s business as usual: HTTP server up, chisel in hand, and we're tunneling like it’s 1999.","Drop the chisel. Tunnel the ports. Talk to the DB like a boss.","Inside the ot_wall_posts, we uncover some juicy lore straight from the dev diaries:","Thanks for the creds, mystery dev. Now, according to OutputMessenger’s official docs (yes, we actually read those), the app needs a buffet of ports open to do its thing. Let’s open the floodgates:","We can now get access to OutputMessenger on http://localhost:14123 with the credentials from the posts. In the Dev_Chat they talk about the UserExplorer.exe, also the Admin said the following:","Translation: “Linux users? Sorry babes, go get a real OS.”","So yeah, looks like we’re installing the Windows client if we want this app to actually function. Time to bootleg some enterprise nostalgia."]},{"l":"OutputMessenger Windows Client","p":["“hey, wanna open calc.exe on ur coworker's PC at 3am? go for it.”","Alright, we indeed see that Martinez is part of this chat room. In order to read the chat logs, we need to also find the roomkey according to the docs. We have to start looking for this on the DC. We log in as winrm_svc and find an OM.db3 file in the AppData folder of this user. We download it and open it with a database viewer. In one of the tables we find the key.","At the bottom, we find the credentials for o.martinez.","At this point you can switch back to a Linux VM or continue on Windows if you prefer ;)","Decryption key is hardcoded","Encrypted password is stored as a Base64 blob","From the application, there is a feature to run programs and open website on a designated time. When we try this out and for instance just launch the default browser application, it indeed opens on the local machine. Just a spicy lil feature called \"Scheduled Events\", which basically goes:","I also noticed that Martinez always is in the idle state so maybe we can upload a reverse shell to the DC and execute it in the context of Martinez. Let's try! Metasploit payload goes brrr...","IV is literally all zeroes (because who needs cryptographic hygiene anyway)","Naturally, we drop this mystery EXE into dnSpy, crack it open, and bingo — inside the LdapApp class is the hardcoded equivalent of a security red flag:","Now I create a new event with a nearby time, logout and login as k.turner with pass MessengerApp@Pass! and wait. You also need to have the same binary in your local machine in order to create the event. Just make sure martinez stays online. If not? Cry harder, reset the box, and try again. Eventually you will get a shell bro.","Now that we’re inside, we peek into the dev chat and snatch a copy of UserExplorer.exe. Because apparently in this workplace, sensitive tools are passed around in chat messages like memes.","Now we can attempt to read the logs by specifying a date range.","Now we can proceed to see what we can do with the API key. Reading the docs of OM, this is one of the request that can be made.","So here’s the tea:","So martinez been cryin in the club (OM chat) like \"wahh my desktop opening random websites at 9AM \uD83D\uDE2D\". Bro. you fr just told me you got task scheduler malware edition installed and running.","So we spin up the Windows OutputMessenger client (don’t ask how we still trust this thing), login as our dev-king m.harris using the creds from the earlier DB leak: D3v3l0p3r_Pass@1337!","The DecryptString function just base64-decodes the ciphertext, then runs AES-CBC using that key and the null IV. Easy bake oven level decryption. We can decrypt this with the following Python script:","Therefore we also need to forward port 14125 and send the following request.","Unfortunately, these are not domain credentials but we can still login to the OM client again. The message with winrm_svc also mentioned the following:","Username is winrm_svc","We can also login to Output Messenger as this user and find a spicy little post from Martinez, casually admitting he dropped his password in the Chiefs_Marketing_chat room like it's just another Tuesday. The winrm_svc account also has a note with the lan_management api key.","We recover the password as WinRm@$svc^!^P. Now we can also WinRM with this user, which saves us some headaches of resetting passwords and grabbing TGTs."]},{"l":"PCAP Analysis and BitLocker Decrypt","p":["So we pokin’ around in Martinez’s AppData, and guess what man’s got tucked away in the digital sock drawer? A juicy lil .pcapng file sittin’ there like it didn’t just witness a whole cybercrime. File’s named network_capture_2024.pcapng—real subtle. Naturally, we snatch it. Set up a quick n’ dirty Python upload server on our end, then slap that file across the internet like we’re trading bootleg mixtapes.","Now inside the capture, we dig up two little digital treasures:","A sketchy-looking file labeled BitLocker-backup.7z(because encrypting your own encryption is totally normal, right?)","A cleartext password floating inside an API call: M@rtinez_P@ssw0rd! dropped casually in a change_auth_token request. Like bro, you good?","Armed with the creds, we RDP into Martinez’s box. Like legally? No. But efficiently? Absolutely. Anyway, this zip file’s got a password on it. Of course it does. But we ain’t scared of some password-protected nonsense. We hit it with that zip2john→ hashcat combo and let RockYou do what RockYou does best.","Password? Man, it’s just zipper. Truly the creativity is off the charts. Inside? The BitLocker recovery key. That’s like finding the keys to someone’s panic room inside their junk drawer.","We use that shiny new key to unlock the drive like we’re defusing a bomb in a B-movie, and what do we find?","Oh, just a full Windows Server 2012 backup sittin’ in the Documents folder of Administrator. You know, just casual enterprise-grade secrets lying around like loose change. And inside that backup? The crown jewel: NTDS.dit and the registry hives. Time to fire up ntdsdotsqlite, turn that chunky binary blob into an actual database we can poke at like the gremlins we are:","We found the password for the lan_management account."]},{"l":"Bloodhound LAN_MANAGMENT to INFILTRATOR_SVC","p":["So now that we deep in this bish, rootin' around like cyber raccoons, we stumble on a shiny lil gem: the gMSA password for infiltrator_svc$. Yeah, you heard me— group managed service account type beat. The kind of account that's like, “I rotate my password so you can’t get me,” but guess what? We got you, bozo.","We ain't talking basic creds here—this is like finding the keys to a vending machine and the cash drawer and the building it's in. You ever seen Windows hand out secrets like this? This is that you-left-your-safe-open-and-taped-the-combo-to-it energy.","How we do it? We just whisper real nice to AD, and it hands us the whole encrypted blob like:","“Hey king, here's the service account's whole-ass credential. Don't spend it all in one Kerberos.”","One quick decrypt later and boom: password’s sittin’ in plaintext like it paid rent. Now infiltrator_svc$ is ours to command. And with a gMSA under your belt? Bro, you’re not just in the network. You are the network.","Let’s cook."]},{"l":"Certipy","p":["We back on the grind and it’s time to hunt some ADCS sauce. Fire up that Certipy like it’s a radar gun pointed straight at Microsoft’s feelings.","JSON hits us back with that sweet, sweet ESC4 vulnerability. And guess who’s got it? That’s right— INFILTRATOR.HTB\\\\infiltrator_svc out here holdin’ dangerous perms like it’s his mixtape. Now if you don’t know about ESC4—lemme hit you with the lore:","ESC4 means our boi has write access to a certificate template. Which is basically like giving a random intern edit rights to the company’s security policy and just hopin’ for the best.","We ain't just playin' with fire, we out here installin’ a gas line to the template. Once we can overwrite the template’s settings, we just sprinkle a little bit of ESC1 dust on it (you know, allow client auth, no manager approval, enroll enabled, all that good good) and suddenly it’s not just a template anymore—it’s a ticket printer.","And guess who’s standin’ in line for that golden cert? We are. This ain't exploitation. This is straight-up admin cosplay with full privileges. Let’s go cook that cert and print ourselves a domain takeover, easy-bake oven style.","And just like that... We’re logged in as Administrator.","Box rooted. Just pure ACL wizardry and a cert with too much ambition. Time to stroll into C:\\Users\\Administrator\\Desktop, pop open that root.txt, and whisper sweet nothings to the final flag.","GG. Game. Over"]}],[{"l":"Office (Hard)"},{"l":"Synopsis","p":["The \"Office\" machine on HackTheBox is a challenging Windows-based environment that incorporates a variety of vulnerabilities. These include exploiting a Joomla web application, analyzing PCAP files to extract Kerberos credentials, leveraging LibreOffice macros by manipulating registry settings, abusing MSKRP to dump DPAPI credentials, and exploiting Group Policies due to excessive privileges in Active Directory."]},{"l":"Reconnaissance","p":["The initial phase begins with an nmap scan, revealing that the target is a Windows Domain Controller.","The domain being used is office.htb and the Domain Controller is called DC so we can add those to our /etc/hosts file."]},{"l":"Joomla Website","p":["On accessing the website, we encounter a Joomla CMS for \"Tony Stark's Iron Man Company\". By checking the version, we identify it as 4.2.7, which is vulnerable to a known exploit ( CVE-2023-23752).","Joomla Version","We find a PoC script for CVE-2023-23752 on GitHub. Running the exploit provides us with a username and password.","Trying to login as the Administrator account on the Joomla backend fails. Looking at the endpoint where this password was found, it looks like this is the password for the Joomla database, so for now we proceed."]},{"l":"Domain Enumeration","p":["With port 88 open, we proceed to enumerate domain usernames using kerbrute, successfully identifying several valid accounts.","We found 6 usernames from the jsmith wordlist and add them to our ad_users.txt list."]},{"l":"Foothold"},{"l":"Access as Dwolfe","p":["By performing a password spraying attack using NetExec we gain access to the domain with the dwolfe account.","We explore the accessible shares, discovering a PCAP file that holds valuable information.","The user dwolfe has access over the SOC Analysis share and can connect to the share using smbclient.","The share contains a PCAP file, so lets inspect this further with WireShark. We start by showing the Protocol Hierarchy and notice there are several frames for the Kerberos protocol.","PCAP Protocol Hierarchy","Filtering the packets on the Kerberos protocol we notice an NTLM authentication session using SMB, which transmits an AS-REQ. In the second AS-REQ packet, we have a hashed timestamp. We can use this information to attempt to crack the password of the user that tried to authenticate.","PCAP Kerberos As-Req","We can create a Kerberos Pre-Auth hash for the user tstark. To do this we first have to check the format that is expected by Hashcat.","Hashcat kerberos example","We can now reconstruct the hash and crack it.","We found the credentials to be tstark:playboy69."]},{"l":"Lateral Movement"},{"l":"Access as TStark (User)","p":["We found that tstark is also the administrator user for the Joomla backend so we can login with the following credentials: Administrator:playboy69. Next we can go to System Site Templates and select the available template. We can then add a web shell on one of the available pages (e.g. error.php) to get remote code execution.","Joomla RCE","We test if we can get remote code execution with the following command:","Looks like we have command execution, so lets try to get a reverse shell. We can try to get a shell as tstark directly by using RunasCs.exe since we know the password of this user on the machine. We will start a Python webserver on our host and run the following commands to download our executable and get a shell.","We start a pwncat listener to catch our shell. Afterwards we get a shell as tstark and can get the user flag."]},{"l":"Access as PPotts","p":["Looking at the installed applications, we notice LibreOffice 5 is installed.","Older versions of LibreOffice usually have vulnerabilities that allow for code execution if a user opens a malicious document. To find the exact version we can execute the following command.","Looking further we also find an internal website. Quickly looking at the source code seems like we can upload a resume, but we cannot find this to be a public facing website.","After looking a bit further, we can find a virtual host configuration in C:\\xampp\\apache\\conf\\httpd.conf. It looks like the internal website is running on port 8083.","We can try to access the internal website by uploading a Chisel agent on the host.","We can now access the internal website by browsing to http://127.0.0.1:8083 and we also find the page where we can upload a resume.","Web form resume upload","Looking back at the source code, we are only allowed to upload Word documents that are smaller than 5Mb in size. When trying to create a .odt document with a Macro, we can't actually execute it on the machine. This means that there might be some extra protections in place."]},{"l":"Reduce Macro Security","p":["According to the LibreOffice Wikipedia, there are registry values that can be used to control the security of the application. We can search for the MacroSecurityLevel registry key that shows the current settings.","The value is set to 3, which means it's set to High Security level. We need to find a way to change this value to allow our macros to trigger. The ACLs on this key show that the Registry Editors group has FullControl and lucky for us we are also part of this group.","So we are able to update the MacroSecurityLevel key.","We can now create a document with a malicious macro with MetaSploit.","Next we upload the generated file to the server and wait for the macro to get executed. This may take a minute or two."]},{"l":"Access as HHogan","p":["After getting a shell as the user ppotts we can start to do some pillaging and look for any saved credentials on the current account. Executing cmdkey /list reveals there is also a saved credential for the user HHogan. Looking at the privileges of this user, we see that this account is part of the Remote Management Users group.","This means that if we are able to recover the credentials of this account, we can most likely connect over WinRM. To get these credentials we can use DPAPI. The DPAPI credential files are decrypted using the user's password, and can be decrypted with the master key or the domain key in case we have access as a domain administrator."]},{"l":"Root","p":["We see three protected files and to be able to extract any data from them we need the master key."]},{"l":"Mimikatz Credential Extraction","p":["In order to get the secret out of these blobs we would normally need to know the user's password. However, since we are logged in we can query the Domain Controller to retrieve the secrets for us. Since we own the master credentials associated with our own account, we can abuse this component by using the /rpc flag in Mimikatz. We will first upload a copy of mimikatz.exe and run it to extract the master key.","The second blob is the correct one (oldest date) and we can find the master key at the bottom. We can then decrypt the blobs using this master key and find a password in the second credential blob."]},{"l":"GPO Abuse","p":["With the found DPAPI credentials we can now get a WinRM session with the user HHogan. This user is a member of the GPO Managers group and there are a few GPOs in the domain.","We can assume that this user can edit GPOs (this can be confirmed by running BloodHound). GPOs, or Group Policy Objects, are policies that Windows uses to manage computers at scale. We can use a tool SharpGPOAbuse in order to create a Policy that adds us as a local admin.","The first policy fails, so lets try to use the second one.","This doesn’t take effect until the GPO refreshes, but we are allowed to run gpupdate /force. Afterwards we need to exit our current WinRM session and authenticate again for the changes to take effect. We can then see ourselves in the BUILTIN\\Administrators group and can access the Administrator desktop."]}],[{"l":"University (Insane)"},{"l":"Synopsis","p":["University is an Insane Windows Active Directory machine that starts with a university webpage. The web application allows exporting user profile pages to a PDF using xhtml2pdf, which is vulnerable to a Remote Code Execution vulnerability via CVE-2023-33733. This allows getting initial access to the machine. Subsequently, the account of a professor is compromised using a forged certificate. With the professor's account, a malicious archive file is uploaded to exploit CVE-2023-36025, which allows getting Remote Code Execution as the user who extracts the archive. A relay attack is then meticulously set up to perform an unconstrained delegation attack. On the newly compromised computer, the Kerberos ticket for a new user is extracted, enabling the reading of the password of a group-managed service account. This account can impersonate the domain Administrator, thus compromising the entire environment."]},{"l":"Enumeration","p":["First thing we do is sign up for an account on the university.htb site. While that’s cooking in the background, we’re also multitasking like it’s finals week by running kerbrute to find some valid users in the domain.","We now have a nice starter pack of usernames — professors, students, maybe that one guy who still emails in Comic Sans. Once we log in to the site, we peep this feature that lets you request a signed certificate. The site hits us with:","Bro... that’s basically giving users a get-in-free wristband. Let’s test it. We make a Certificate Signing Request (CSR) with openssl:","Key things here:","Common Name (CN) = your username on the site","Email = same one you registered with","Everything else = filler","Upload the CSR, the site signs it, and you get a key you can use to log in without a password. Cute feature, but we can only sign certs for our account... so no professor impersonation yet.","Doing some clickety-click enumeration, we find a staff profile page at http://university.htb/accounts/profile/visit/2/:","Now obviously, my villain arc would be to make a cert for George and sneak into professor-only land... but the site says “nah fam” if we try to sign a cert for anyone we’re not logged in as. So for now — we’re locked to our own account cert. We ball later."]},{"l":"Foothold","p":["So while poking around the site in my “click every button like a toddler” era, I notice this cute lil’ Export Profile to PDF feature. Being the nosy menace I am, I yeet that file into exiftool like:","Boom — ReportLab shows up in the metadata like \"hey bestie, wanna pwn me!\". Turns out, ReportLab has CVE-2023-33733, a vuln so unhinged it basically lets you cosplay as the server’s Python interpreter. Like bruh, imagine putting your resume into LinkedIn and suddenly LinkedIn starts running your shell commands. So naturally, I stuffed my bio with something... special:","Translation: curl my PowerShell reverse shell from my attacker box. Then I run a Python webserver on port 8000 to serve the goods, which downloads our PowerShell reverse shell.","Meanwhile, I’m also running netcat and get a callback as the domain user university\\wao."]},{"l":"User","p":["I’m chilling in my fresh shell as university\\wao, feeling like I just unlocked a secret character skin, when I peep my group memberships... Remote Management Users. So if I can snag this user’s password, I get to WinRM my way in like it’s the VIP lounge at cyberclub.","So I start creeping around the filesystem like a raccoon on a 3 AM 7-Eleven snack run, nosing in everything, praying for leftover pizza crusts (aka plaintext creds). And what do I stumble on? A folder literally named C:\\Web\\DB Backup. Yeah... they really put “Backup” in the name and thought I wouldn’t look.","Inside, I find a PowerShell script called db-backup-automator.ps1. And let me tell you — the vibes are immaculate. That filename alone is giving “I hardcoded something spicy in here but gaslit myself into thinking no one would ever find it.” Naturally, I’m opening that thing faster than I open DoorDash when I’m in my snack phase.","So I crack open db-backup-automator.ps1 and, surprise surprise, it’s doing a little \"backup the DB and encrypt it\" routine — but the password it’s using? Bruh. It's giving lazy dev energy. The script's password is basically WebAO1337, and since my user is WAO, the math is mathing. I spit those creds into WinRM:","And now I’m just sitting here like, pls work, because if it does, we’re about to upgrade from \"sneaking in through the bathroom window\" to \"walking in through the front door with main character energy.\"","Pulled the db.sqlite3 straight off the server with Evil-WinRM — feeling like the main character already. Peep inside the DB and we got user creds and CSR file locations.","Most of it is pretty mid... until I spot professor Nya’s CSR sitting there all cute. Little endpoint fuzzing later and now I’ve also yoinked martin.rose’s CSR at http://university.htb/static/assets/uploads/CSRs/5.csr.","Since we've basically got the keys to the kingdom (rootCA cert + key from the server), I whip up a professor cert for Martin like I'm running my own shady university IT department. Openssl be like “Certificate request self-signature ok” — yeah, it better be.","Professors can upload lectures, but the files need to be signed. Cool, so I spin up a GPG key for our fake professor and decide to get messy with it.","Since this machine has not been updated for some time, we can suspect it being vulnerable to CVE-2023-36025. So I cook up the most suspicious shortcut of all time: drop a batch file on C:\\Windows\\Temp, yeet a .url link to it inside a ZIP, slap a signature on it like I’m forging hall passes, and then upload it for the Content Evaluators like, “hey bestie, pls click my totally legit file ❤️.”","Except... crickets. No callback. Alright, pivot time. Ping sweep the 192.168.99.0/24 subnet, find WS-3 and LAB-2 just chilling. Fire up Ligolo-ng, proxy up, route the subnet, and remote into WS-3 like it’s my side chick.","We can also SSH into LAB-2 with WAO’s creds and immediately sudo su into root — easiest W of my life.","Alright, so plot twist time — instead of begging the main server to run our payload, we switch to “what if WS-3 does the heavy lifting?” energy. The idea: if a file gets opened from WS-3, we can make it point straight to LAB-2 and skip all the drama. So I tweak my reverse shell to target LAB-2's IP (192.168.99.12) instead:","Now the plan is simple: craft the .url file so it points at that batch file living on WS-3. As soon as some unsuspecting professor/admin clicks the shortcut, WS-3 will execute it, and boom — the callback will land right in LAB-2’s waiting arms."]},{"l":"Root","p":["Right — now that we’ve got Martin.T on WS-3, that “not updated since 10/29/2023” note is basically a neon sign saying “Potato season is open”. The date is hinting to the latest Potato exploit called LocalPotato(a.k.a CVE-2023-21746). This exploit makes it possible to overwrite any file on the server, so let's look for things that seem worthwhile.","One file at C:\\Program Files\\Automation-Scripts\\wpad-cache-cleaner.ps1 seems to be an automated cleanup script. If this script runs with higher privileges (scheduled task, service, or startup script), swapping it out for our payload means the next time it runs, we get a SYSTEM or admin shell.","We will create the following shell.ps1 reverse shell script and then upload it to WS-3:","Now we perform the Potato exploit and start a new netcat listener on LAB-2.","Boom — potato’s baked and served. After sitting there like a sniper in the bushes for ~ 10+ minutes, the task finally ran and called our reverse shell.","That’s full local admin on WS-3. Now there are several ways to get the root flag."]},{"l":"Method 1","p":["Ok so first move — dump any user Kerberos tickets from memory and pray we find one. Run Rubeus, dump all tickets, jackpot — Rose's TGT is just sitting there in memory like it’s on clearance. We grab that Base64 ticket, renew it, and inject it straight into our current session with /ptt.","Quick klist check and boom, we’re literally her now.","From BloodHound we see Rose has ReadGMSAPassword rights on the GMSA-PClient01$ account. That’s spicy because that means we can read the machine account password and escalate to Domain Admin with an RBCD attack.","Drop GMSAPasswordReader.exe, tell it to target \"GMSA-PClient01$\", and it hands over every hash flavor — RC4, AES128, AES256, DES. The RC4 hash is all we need for the next step.","Since GMSA-PClient01$ is AllowedToAct on the DC, we use Rubeus S4U to impersonate the administrator, requesting a service ticket for CIFS and WinRM on the DC. We inject that ticket, klist again, and it straight up says Client: administrator @ UNIVERSITY.HTB. Thats root baby!"]},{"l":"Method 2","p":["Another option we have is to dump the SAM database (download it with session in Evil-WinRM). Then we run secretsdump.py to to spit out every hash in the system, including the golden ticket: a default password chilling in plaintext.","We see v3ryS0l!dP@sswd#X and think: ohhh this is too easy. Password spraying time.","Run it against ad_users.txt with NetExec, and guess what? Brose.W is just waiting there with the same password, Backup Operators group, ripe for some NTDS shadow-copy shenanigans.","We fire up Evil-WinRM as Brose.W, drop diskshadow .dsh script, spin up a shadow copy, robocopy the NTDS.dit like it’s Hot Wheels. Download them, feed them to secretsdump.py, and it’s raining domain hashes.","Final move? We got the Administrator hash in our hands, meaning it is Pass-the-Hash time. We SMB to the DC, grab root.txt, sit back, sip whatever beverage hackers sip while the domain collapses in slow motion.","Boom. University.HTB? Ours. Every ticket stolen, every hash cracked, every default password abused. The network? Toast. The flags? Collected. The lesson? One tiny slip in AD, one exposed secret, and the kingdom crumbles. Chaos achieved, mission complete."]}],[{"l":"Vintage (Hard)"},{"l":"Synopsis","p":["Vintage is a hard difficulty Windows machine designed around an assumed breach scenario, where the attacker is provided with low-privileged user credentials. The machine features an Active Directory environment without ADCS installed, and NTLM authentication is disabled. There is a 'Pre-Created computer account', meaning the password is the same as the sAMAccountName of the machine account. The 'Domain Computer' organisational unit (OU) has a configuration allowing attackers to read the service account password, which has gMSA configured. After obtaining the password, the service account can add itself to a privileged group. The group has complete control over a disabled user. The attacker is supposed to restore the disabled user and set a Service Principal Name (SPN) to perform Kerberoasting. After recovering the password, the user account has reused the same password. The newly compromised user has a password stored in the Credential Manager. The user can add itself to another privileged group configured for Resource-Based Constrained Delegation (RBCD) on the Domain Controller, allowing the attacker to compromise it."]},{"l":"Reconnaissance","p":["For this machine we are given some initial credentials to authenticate ( P.Rosa:Rosaisbest123) and the initial nmap scan already shows we are dealing with a Domain Controller.","We start by checking our connection with NetExec.","We get back the error STATUS_NOT_SUPPORTED. We can verify if Rosa is a valid user by running Kerbrute. I just made a small wordlist that included Rosa along with some default accounts.","We see that Rosa is indeed a valid user, so there is something odd going on here. Something else thats worth a try is doing further enumeration over LDAP. Using ldapsearch, we can try to get a list of all domain users."]},{"l":"Kerberos Authentication","p":["After using some common queries over ldap, I decided to retry using NetExec with the -k flag which uses Kerberos as authentication protocol instead of NTLM (default). When dealing with Kerberos, you generally don't want to use IP addresses and use hostnames instead.","The output looks better. The reason for the STATUS_NOT_SUPPORTED error is that NTLM authentication is disabled on the domain. Luckily NetExec can easily authenticate over Kerberos. I performed a Kerberoasting attack and found 3 machine hashes and one service account hash.","Cracking those hashes with a standard rockyou.txt wordlist does not work. Then I proceeded to run BloodHound."]},{"l":"Foothold","p":["The first thing I found was that the computer account FS01$ belongs to the PRE-WINDOWS 2000 group."]},{"l":"Pre-Created Computer","p":["When a new computer account of this type is configured, its password is set based on its name (i.e. lowercase computer name). Let's verify if we can get a TGT by using the standard password for this computer account.","We managed to save the machine's TGT meaning this is indeed a valid password. Looking at the results from BloodHound again, this account can read the password for the GMSA GMSA01$. And the latter can also add itself it the SERVICEMANAGERS group."]},{"l":"ReadGMSAPassword Abuse","p":["There are several methods we can use to read this password, but the easiest method is to use BloodyAD. Again we need to do our authentication over Kerberos by using the TGT of FS01$."]},{"l":"GenericWrite Abuse","p":["We got the NTLM hash and the Base64 encoded password. We again retreive the TGT of the GMSA account and add ourself to the SERVICEMANAGERS group.","Let's see what control this group has over other accounts.","My initial thought was to create shadow credentials for the accounts that we have control over, but the domain does not support PKINIT. Since we have full control over all these service accounts, another thing we can do is a targeted ASREPRoasting attack in order to crack the hashes. This can be done in BloodyAD by setting the DONT_REQ_PREAUTH flag.","When we now perform an ASREPRoast, we should get the hashes of all three accounts.","We only get two hashes and see that the svc_sql account responds with a KDC_ERR_CLIENT_REVOKED error, meaning that this account is not activated. We can verify if the account is indeed disabled."]},{"l":"Restore Disabled Account","p":["With our GenericAll rights, we can enable the account in order to get the hash."]},{"l":"User","p":["We are only able to crack the password for svc_sql which is Zer0the0ne."]},{"l":"Password Spraying","p":["Well we got a password but the account is not of much use, so lets do some password spraying.","The password is also valid for the user C.Neri. This user is also part of the Remote Management Users group so this will be our initial access."]},{"l":"WinRM with Kerberos","p":["When we attempt to connect via WinRM, we got an error that the KDC cannot be found. To fix this we need to edit our /etc/krb5.conf file as follows:","We can now login with Evil-WinRM and get the user flag."]},{"l":"Root"},{"l":"DPAPI Credential Extraction","p":["We can look for any stored credentials and try to extract them. The DPAPI (Data Protection API) is an internal component in the Windows system. It allows various applications to store sensitive data (e.g. passwords). The data are stored in the users directory and are secured by user-specific master keys derived from the users password. They are usually located at C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Protect\\$SUID\\$GUID. Lets have a look if our user has any credentials stored.","We can download the credential file and masterkey to our local machine and use dpapi.py to extract them.","We found a password for the user c.neri_adm."]},{"l":"RBCD Attack","p":["This user is part of the DELEGATEDADMINS group. Members of this group have the msds-AllowedToActOnBehalfOfOtherIdentity attribute on the computer DC01.VINTAGE.HTB. We can use these privileges to execute a modified S4U2self/S4U2proxy abuse chain to impersonate any domain user to the target computer system and receive a valid service ticket \"as\" this user. However, in order to perform the attack we need to have access to an account with an SPN set.","The trick here is that the user c.neri_adm has GenericWrite over the DELEGATEADMINS group and from earlier we have full control over the service account svc_sql. Therefore we can add this account to the DELEGATEADMINS group and add a fake SPN to the account. By doing this we have all the requirements for a constrained delegation attack. Lets add the svc_sql user to the group, change the SPN and get their TGT.","In BloodHound the permissions will now look as follows:","With the TGT of svc_sql we can now perform a S4U2Self attack in order to impersonate L.BIANCHI_ADM since this user has complete control over the domain."]},{"l":"DCSync","p":["Now we can perform a DCSync attack and grab the root flag."]}],[{"l":"Yummy (Hard)"},{"l":"Synopsis","p":["Yummy is a hard box that starts with a Restaurant web app using Caddy web service, on port 80, where an attacker finds an arbitrary file read HTTP Location header, which is not handled and sanitized properly by the default Caddy configuration. This allows an attacker to find several cronjob scripts that allow downloading the web app source code. Reading the source code, the web app uses JWT RSA keypairs to forge an admin token and escalate privileges on the web app. The admin panel has an SQL injection, allowing arbitrary file write over a file running periodically ( cronjob). Improper directory permissions allow the attacker to move laterally to www-data and eventually a dev user. The dev user can execute rsync binary as root, which helps escalate privileges to root."]},{"l":"Reconnaissance","p":["Our initial port scan only shows two ports open: SSH on port 22 and a web server on port 80. By looking at the http-server-header, we identify that the server is running Caddy as a reverse proxy.","Navigating to the website redirects us to yummy.htb. We add this domain to the /etc/hosts file and continue to explore the webpages. The website is hosting a restaurant application to manage appointments and reservations. After creating an account and logging in, we can make a new reservation.","From our dashboard, it is possible to save our reservation to a calendar file (ics) via the save iCalendar option.","The request makes a call to the /export/Yummy_reservation_YYYYMMDD_hhmmss endpoint where the date is the current timestamp of the export. This endpoint is vulnerable to LFI and we can alter the request to read arbitrary files as the www-data user. Another thing to notice is that the cookie uses a JWT token which can be decoded with tools like CyberChef or jwt.io. Decoding the token, there's a role customer and fields e and n are specified, which are essential encryption exponent and modulus respectively.","Manipulating the GET request to /export/../../etc/passwd gives us Arbitrary File Read.","From the /etc/passwd file, we can already identify several users on the machine.","Further enumeration reveals that the contents of the /etc/crontab file contains some scripts.","We can download those files via the LFI vulnerability and check their contents."]},{"l":"App Backup","p":["The contents of the app_backup.sh script reveals the location of a zip file in the /var/www directory.","We can download the backed-up file from /var/www/backupapp.zip. This zip file is a backup of the original source code located in /opt/app. Once unzipped, we can view the content of app.py.","We can proceed to do some code analysis and see if we can spot additional vulnerabilities or credentials. The login method in app.py looks interesting. The pair of RSA keys are generated in the config/signature.py. The validation is done in the middleware/verification.py.","It uses the signature.py module to encode the payload into a JWT token. The payload does contain the RSA modulus n and the encryption exponent e. With knowledge of these values, we can decode any JWT token to find the original prime factors p and q and break the encryption.","Let's have a look at how we can decode our customer token and modify it to become administrator.","We insert our current user JWT token in our script and run it. This will then print out a new JWT that has the administrator role and should be able to access the admin panel. Further along in the code of app.py there is also an SQL Injection vulnerability in the admindashboard endpoint."]},{"l":"Foothold","p":["Let's perform a search query on the admin dashboard and intercept the request with BurpSuite. We can confirm the SQL Injection by making the server sleep for several seconds.","By using SQLMap we can check our user privileges:","We have FILE permissions, meaning we can read and write arbitrary files. Remember we still have a couple of cron scripts we haven't looked at yet, one of which is the dbmonitor.sh script owned by the mysql user. After we download this file via the same method as before, some things stand out.","If the file dbstatus.json exists and does not conain the string \"database is down\" then it runs a command with /bin/bash, afterwards it deletes the JSON file. This script is ran every minute. The latest_version variable lists the contents of the scripts folder with a wildcard. This script will sort all scripts starting with fixer-v and executes the last matching script (tail). Since we can write files via the SQL injection vulnerability, we can get a reverse shell.","First we create a reverse shell script and run a Python web server.","We create a small script that automates the exploitation. It first grabs our payload, writes it to /data/scripts/fixer-v999 and then writes an empty string to /data/scripts/dbstatus.json in order to execute our payload.","We start a netcat listener on port 9001, run the above script and after a minute we should have received a connection back to our machine."]},{"l":"User"},{"l":"Mysql to www-data","p":["After getting a shell as the mysql we still have very limited access. We can move laterally to the www-data user since there is also a script ( app_backup.sh) that runs every minute by this user. We are able to remove the backup file and replace it with the same reverse shell script.","We again run a netcat listener to catch the shell (it might take a few tries)."]},{"l":"www-data to qa","p":["We can find a password for the qa user in the /var/www/qa_testing/.hg/store/data/app.py.i file.","We can now SSH as qa."]},{"l":"Root"},{"l":"QA to Dev","p":["The qa user can run a command as the dev user.","Looking online this command is used by Mercurial SCM. In our home folder we have a .hgrc file that contains some configuration options. One option of Mercurial is to create hooks that run before/after certain actions. From the Mercurial Docs there is also a hook called post-command that runs after successful invocations of the associated command.","Again we download our shell and modify the .hgrc file to run our shell after a pull request. Next we run a netcat listener and perform the pull request as the dev user.","When running the command, we get a permission denied error so we try another way. From the same documentation, you can also specify the configuration file inside the .hg folder per repository. We can create this file in the /tmp directory and then try to run our exploit again."]},{"l":"Dev to Root","p":["We now have a shell as the dev user that can run rsync as root. Rsync is a tool for synchronizing files and directories between location.","We can exploit this by copying the root user's private SSH key. One quick way to read the root flag or root SSH key is using the following command:","The key element is the --chmod flag of the rsync binary. This additional parameter changes the ownership of the copied file. Since we are the dev user, all files will be copied under our permissions, so this option lets us change the permission of file we copied from the root directory. Now we can copy the SSH key and login as the root user."]}],[{"l":"ProcNet (Hard)"},{"l":"Synopsis","p":["With the increasing use of open-source Command and Control (C2) frameworks by threat actors, it has become crucial for blue teams to develop strategies to detect and mitigate these threats. In this exercise, our red team simulated an attack using a popular open-source C2 framework to help improve defenses. We were provided with PCAP files, EVTX logs, and API traces, which we will analyze to uncover the attack's methodology."]},{"l":"Introduction to Tools and Files","p":["During this investigation, we will use various tools to examine the artifacts:","Wireshark for analyzing the network traffic captured in PCAP files.","API Monitor to track API calls made by malicious executables.","VirusTotal to identify and analyze potential malware.","One of the less familiar file types encountered, .apmx64, is associated with API Monitor, a powerful tool for monitoring and controlling API calls made by applications. This tool was instrumental in understanding the behavior of the malware on the host."]},{"l":"Analyzing the Packet Capture"},{"l":"CSGO Malware Download and Execution","p":["We begin by examining the Employee.pcapng file using Wireshark. Filtering the traffic by the HTTP protocol, we quickly identified a file named csgo.exe being downloaded.","PCAP File Download","The download was completed around 7:22:22 UTC. Following this, the malware attempted to establish a connection with a remote IP address ( 3.6.165.8) over port 443, likely to secure its communications using TLS.","PCAP Malware Connect","This type of communication is typical of C2 servers, where the malware contacts a command server to receive further instructions or to exfiltrate data. To further analyze the server, we extract the JA3 fingerprint from the TLS handshake.","The JA3 fingerprint is a unique identifier generated from the client's TLS configuration, which can be used to detect malicious activity even if the IP address changes.","PCAP Malware C2 JA3"]},{"l":"Identifying the C2 Framework: Sliver Detection","p":["To determine the C2 framework being used, we can extract the csgo.exe binary from the packet capture by following the TCP stream of the HTTP request and exporting the payload. We will then upload this binary to VirusTotal for analysis.","VirusTotal Sliver Detection","VirusTotal identified the binary as associated with the Sliver C2 framework, a popular open-source tool used by both red teams and malicious actors for post-exploitation tasks. Sliver provides various capabilities, including remote command execution, lateral movement, and credential harvesting."]},{"l":"Monitoring API Calls with API Monitor"},{"l":"Accessing Secure Vault Data","p":["The next phase of the investigation involves examining the behavior of the csgo.exe malware on the infected system. Using API Monitor, we can track the API calls made by this process. Early in the execution, the malware retrieved the current working directory using the GetCurrentDirectoryW API call. Shortly afterward, it launched a new process named notepad.exe.","API Monitor Notepad executed","Sliver typically spawns a sacrificial process (often notepad.exe) when using the execute-assembly command, injecting .NET assemblies into the process for execution. This can be changed, but it seems like the defaults were utilized by the operators.","Next, we observe the malware loading the vaultcli.dll module into the notepad.exe process. This library is used to interact with the Windows Credential Manager (often referred to as the Windows Vault), which stores and retrieves user credentials. By loading this DLL, the attacker aimed to enumerate and potentially extract sensitive credentials stored in the vault. API Monitor Vault","The specific API call observed was VaultEnumerateVaults, which lists the available vaults on the system. This suggests the attacker was attempting to identify and access stored credentials, possibly to facilitate lateral movement within the network. Credential theft is a common goal in such attacks, as it allows threat actors to escalate privileges and gain access to additional systems.","API Monitor Enumerating Domain Users","Following the vault enumeration, the attacker initiated another significant action: enumerating domain users. This was done by executing the net.exe utility, a command-line tool used for network administration.","This command lists all members of the \"Domain Admins\" group, which typically has high-level privileges across the domain. Gaining knowledge of these users is crucial for an attacker, as compromising one of these accounts can give them control over the entire domain."]},{"l":"Downloading Additional Malware via WMI","p":["The investigation revealed that after gaining access to domain information, the attacker used WMI (Windows Management Instrumentation) to download another Sliver beacon, named fifa24.exe, to the Domain Controller (DC).","API Monitor Fifa Download","WMI is a powerful feature in Windows that allows for remote management of systems, including executing commands, scripts, and managing files. The attacker used a tool from the Sliver ARMORY called SharpWMI to download and execute this payload on the DC. This indicates that the attacker had already escalated privileges, likely by compromising a domain admin account retrieved from the Windows Vault, enabling them to execute commands remotely on the DC."]},{"l":"Extracting the NTDS.dit File","p":["One of the most critical actions taken by the attacker was the extraction of the NTDS.dit file. This file contains a database of Active Directory (AD) data, including password hashes for all domain users.","API Monitor NTDS Dump","After the file was retrieved, the attacker compressed it using the Compress-Archive PowerShell command:","Compressing the NTDS.dit file and other related files into a zip archive is a common tactic used to prepare the data for exfiltration. Once the file is compressed, it becomes easier to transfer out of the network, typically over encrypted channels to avoid detection."]},{"l":"Conclusion","p":["In this exercise, we observed a sophisticated attack leveraging the Sliver C2 framework, which included the use of process injection, credential harvesting, remote command execution, and data exfiltration. By understanding the tactics and techniques used, blue teams can better prepare for similar threats in their environments."]},{"l":"Key Takeaways","p":["Use of C2 Frameworks: Open-source C2 frameworks like Sliver are increasingly used by both red teams and malicious actors. Being familiar with their behaviors, such as JA3 fingerprints and typical process injections, is essential for detection.","Credential Theft: The attack demonstrated a focus on accessing and leveraging credentials, particularly through Windows Vault and domain enumeration, underscoring the importance of securing credential stores and monitoring access.","Lateral Movement: The use of WMI to move laterally within the network highlights the need for monitoring such administrative tools for unusual activity.","Data Exfiltration: The extraction and compression of the NTDS.dit file show how attackers can target critical AD components, making it imperative to secure and monitor these assets closely."]}],[{"l":"About","p":["Hi, I'm s3rp3nt — a software and cybersecurity enthusiast with a deep interest in building robust software, understanding networks, and exploring the ever-evolving landscape of digital security. My journey into this field began during my studies, where I discovered a love for coding, solving complex problems, and securing systems.","In my free time, you'll often find me sharpening my skills through CTF competitions or platforms like HackTheBox and TryHackMe, where I tackle real-world challenges and hone my expertise.","This blog is my space to dive into the world of cybersecurity and software development. You'll find content covering:","Web security insights","Exploitation techniques","CTF write-ups","Networking concepts and more.","Whether you're a seasoned professional or just beginning your journey in cybersecurity, I hope you’ll find value in these posts.","Let’s Connect! Do you have any comments, questions, or feedback? Don’t hesitate to reach out, I’d love to hear from you!"]}]]